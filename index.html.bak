<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <title>SI√äU TOOL A.I WIN 100%</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;700&family=Roboto:wght@400;700&family=Rajdhani:wght@400;700&family=Fira+Code:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- Tailwind runtime (Play CDN) - KEEP as fallback during development -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- SWAP_TAILWIND_STATIC:
     After running `npm run build:css` (or the npx command),
     replace the CDN script above with the line below and remove this comment:
     <link rel="stylesheet" href="tailwind.css">
-->
    <!-- lazy: Tone.js will be loaded on first user gesture -->
<!-- B·ªî SUNG: Li√™n k·∫øt ƒë·∫øn t·ªáp CSS t√πy ch·ªânh v√† manifest PWA -->
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#00e6e6" />
    
    

<!-- Mobile-specific adjustments for the promo banner to ensure it doesn't overlap the contact link -->

    <!-- Additional responsive styles to ensure the promo banner does not overlap the footer on small screens -->
    

<!-- PWA manifest removed for local file compatibility -->
<!-- <link rel="manifest" href="manifest.json"> -->
<meta name="theme-color" content="#00ffff" />


<!-- Consolidated mobile styles -->



    

    


</head>
<body>
    <canvas id="matrixCanvas" class="background-canvas"></canvas>
    <div id="youtube-player"></div>
    <div id="notification-container"></div>
    
    <div id="authScreen">
        <div id="auth-content">
            <div class="corner-bracket top-left"></div> <div class="corner-bracket top-right"></div>
            <div class="corner-bracket bottom-left"></div> <div class="corner-bracket bottom-right"></div>
            <img id="auth-logo" class="boot-anim" src="https://i.ibb.co/RkhcqgKC/LOGO.png" alt="Logo" style="animation-delay: 0.2s;" loading="lazy" decoding="async" fetchpriority="low">
            <div id="form-container">
                <form id="loginForm">
                    <h2 data-text="ƒêƒÇNG NH·∫¨P"></h2>
                    <div class="boot-anim" style="animation-delay: 0.8s;"><input type="text" id="login-username" placeholder="T√äN T√ÄI KHO·∫¢N" required></div>
                    <div class="boot-anim" style="animation-delay: 1.0s;"><input type="password" id="login-password" placeholder="M·∫¨T KH·∫®U" required></div>
                    <div class="boot-anim" style="animation-delay: 1.2s;"><button type="submit" id="loginBtn" class="btn-primary highlight">K·∫æT N·ªêI</button></div>
                    <p class="auth-switch boot-anim" style="animation-delay: 1.4s;">Ch∆∞a c√≥ t√†i kho·∫£n? <a id="showRegisterLink">ƒêƒÉng k√Ω</a></p>
                    <a href="http://www.f168.codes" target="_blank" class="f168-banner boot-anim" style="animation-delay: 1.5s;">TOOL CH·ªà HO·∫†T ƒê·ªòNG V·ªöI T√ÄI KHO·∫¢N ƒêƒÇNG K√ç T·∫†I S·∫¢NH F168.CODES</a>
                    <!-- Download app banner: provides a prominent call to action for users to install the companion app. -->
                    <a href="https://limewire.com/d/H8Mto#c8FLyO73zq" target="_blank" class="download-banner boot-anim" style="animation-delay: 1.6s;">
                        <!-- Add a Google Play icon so users can immediately recognise the download action -->
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/Google_Play_2022_logo.svg/512px-Google_Play_2022_logo.svg.png" alt="Google Play" style="height: 20px; width: auto; margin-right: 8px;" / loading="lazy" decoding="async" fetchpriority="low" width="512">
                        <span>T·∫¢I APP NGAY</span>
                    </a>
                </form>
                <form id="registerForm" class="hidden">
                    <h2 data-text="ƒêƒÇNG K√ù"></h2>
                    <div class="boot-anim"><input type="text" id="register-username" placeholder="T√äN T√ÄI KHO·∫¢N" required></div>
                    <div class="boot-anim" style="animation-delay: 0.1s;"><input type="tel" id="register-phone" placeholder="S·ªê ƒêI·ªÜN THO·∫†I" required></div>
                    <div class="boot-anim" style="animation-delay: 0.2s;"><input type="password" id="register-password" placeholder="M·∫¨T KH·∫®U" required></div>
                    <div class="boot-anim" style="animation-delay: 0.3s;"><button type="submit" id="registerBtn">T·∫†O M·ªöI</button></div>
                    <p class="auth-switch boot-anim" style="animation-delay: 0.4s;">ƒê√£ c√≥ t√†i kho·∫£n? <a id="showLoginLink">ƒêƒÉng nh·∫≠p</a></p>
                </form>
            </div>
        </div>
    </div>

    <div id="aiCoreSelectionScreen" class="hidden">
            <div id="user-info-bar" class="hidden">
                <!-- Left side: Avatar, pilot info and energy -->
                <div id="user-info-left">
                    <img id="user-avatar" src="https://placehold.co/50x50/0A192F/00ffff?text=P" alt="User Avatar" loading="lazy" decoding="async" fetchpriority="low" width="50" height="50">
                    <div>
                        <span id="user-pilot">PILOT:</span><span id="user-level" style="margin-left:6px;"></span><br>
                        <span id="user-energy">ENERGY:</span>
                    </div>
                </div>
                <!-- Controls section on the far right: includes menu, profile and logout buttons -->
                <div id="user-controls">
                    <!-- Dynamic user menu: functions for account based on level -->
                    <div id="user-menu" class="hidden"></div>
                    <button id="profile-btn" class="control-btn" aria-label="H·ªì s∆°">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>
                    </button>
                    <button id="logout-btn" class="control-btn" aria-label="ƒêƒÉng xu·∫•t">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"/></svg>
                    </button>
                </div>
            </div>
        <h1 data-text="CH·ªåN L√ïI A.I" class="title-vip"></h1>
        
        <div id="core-selector-container" class="relative">
            <div id="core-cards-wrapper"></div>
            <button id="prev-core-btn" class="core-nav-btn" aria-label="L√µi tr∆∞·ªõc"><</button>
            <button id="next-core-btn" class="core-nav-btn" aria-label="L√µi ti·∫øp theo">></button>
        </div>

        <div id="promo-banner">
            <a href="https://www.f168a2.net/home/register?id=409098214&currency=VND" target="_blank" id="promo-text">ƒêƒÇNG K√ç N·∫†P ƒê·∫¶U 8888K - T·∫∂NG V√íNG XOAY MAY M·∫ÆN</a>
            <a href="https://vongxoaylongbao.site/" target="_blank" id="promo-spinner-link"><svg id="promo-spinner" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gold-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color: #fcee0a; stop-opacity: 1" /><stop offset="100%" style="stop-color: #ffd700; stop-opacity: 1" /></linearGradient></defs><g class="spinner-wheel"><circle cx="50" cy="50" r="25" fill="transparent" stroke="#E74C3C" stroke-width="50" stroke-dasharray="26.18 157.08" transform="rotate(-90 50 50)"/><circle cx="50" cy="50" r="25" fill="transparent" stroke="#F1C40F" stroke-width="50" stroke-dasharray="26.18 157.08" transform="rotate(-30 50 50)"/><circle cx="50" cy="50" r="25" fill="transparent" stroke="#2ECC71" stroke-width="50" stroke-dasharray="26.18 157.08" transform="rotate(30 50 50)"/><circle cx="50" cy="50" r="25" fill="transparent" stroke="#3498DB" stroke-width="50" stroke-dasharray="26.18 157.08" transform="rotate(90 50 50)"/><circle cx="50" cy="50" r="25" fill="transparent" stroke="#9B59B6" stroke-width="50" stroke-dasharray="26.18 157.08" transform="rotate(150 50 50)"/><circle cx="50" cy="50" r="25" fill="transparent" stroke="#1ABC9C" stroke-width="50" stroke-dasharray="26.18 157.08" transform="rotate(210 50 50)"/></g><circle cx="50" cy="50" r="48" fill="none" stroke="url(#gold-gradient)" stroke-width="4"/><path d="M50,0 L45,15 L55,15 Z" fill="var(--gold)" stroke="var(--dark-blue)" stroke-width="1" /><circle cx="50" cy="50" r="12" fill="var(--dark-blue)" stroke="var(--gold)" stroke-width="2"/><circle cx="50" cy="50" r="8" fill="var(--gold)"/></svg></a>
        </div>
    </div>
    
    <div id="chat-robot-container" class="hidden">
        <div id="robot-speech-bubble">t√¥i l√† a.i long b·∫£o</div>
        <div id="chat-robot-icon">
            <iframe src="https://giphy.com/embed/KOjYutEk4WwvXIwHH6" width="100%" height="100%" style="position:absolute; pointer-events: none;" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
        </div>
    </div>
    <div id="chat-window-container" class="hidden">
        <div id="chat-window">
            <div id="chat-messages"></div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="H·ªèi A.I LongBao... (-5 NƒÉng L∆∞·ª£ng)" autocomplete="off" required>
                <button type="submit" id="chat-send-btn">G·ª¨I</button>
            </form>
        </div>
    </div>


    <div id="longbaoIVScreen" class="hidden">
        <canvas id="longbaoIV-background-canvas"></canvas>
        
        <div id="table-selection-screen" class="screen">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <button id="exit-longbao-btn-tables" class="box-panel p-2 rounded-md hover:bg-slate-700 transition-colors z-50 text-white">Tho√°t L√µi</button>
                    <h1 class="text-2xl sm:text-4xl font-bold text-center text-[var(--neon-green)] glow-text-gold tracking-widest box-panel py-2 px-4">CH·ªåN B√ÄN CH∆†I</h1>
                    <div style="width: 80px;"></div> </div>
                <div id="table-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 cv-auto">
                    </div>
            </div>
        </div>

        <div id="tool-screen" class="hidden screen">
            <button id="back-to-tables-btn" class="fixed top-4 left-4 box-panel p-2 rounded-md hover:bg-slate-700 transition-colors z-50 text-white" aria-label="Quay l·∫°i ch·ªçn b√†n">
                V·ªÅ S·∫£nh
            </button>
            <div class="hud-corner top-left"></div><div class="hud-corner top-right"></div>
            <div class="hud-corner bottom-left"></div><div class="hud-corner bottom-right"></div>
            <div id="main-content" class="relative z-10 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                <div class="lg:col-span-1 flex flex-col gap-4 lg:gap-6">
                    <div class="box-panel p-3 sm:p-4">
                        <h2 id="tool-title" class="text-lg sm:text-xl font-bold text-[var(--neon-gold)] tracking-widest flex items-center gap-2 mb-2">D·ª∞ ƒêO√ÅN</h2>
                        <div class="w-full bg-slate-700/50 rounded-full h-1 mb-2"><div id="countdown-bar" class="countdown-bar"></div></div>
                        <div id="energy-bar-container" class="relative w-full bg-slate-800 rounded-full h-5 border-2 border-slate-600 p-0.5 overflow-hidden">
                            <div id="energy-bar" class="h-full rounded-full transition-all duration-500"></div>
                            <span id="energy-text-lb4" class="absolute inset-0 text-xs font-bold flex items-center justify-center text-white" style="text-shadow: 1px 1px 2px black;">100%</span>
                        </div>
                        <div class="relative glow-border-gold h-32 sm:h-40 rounded-md flex flex-col items-center justify-center p-2 sm:p-4 overflow-hidden mt-2">
                            <div id="shockwave-container"></div>
                            <p id="main-prediction-text" class="text-5xl sm:text-6xl font-bold text-gray-500">CH·ªú...</p>
                            <p id="sub-prediction-text" class="text-base sm:text-xl font-semibold text-gray-500 mt-2 h-8"></p>
                        </div>
                        <div id="ai-reasoning" class="mt-2 text-center text-sm p-2 bg-black/20 rounded-md border border-cyan-500/20">
                            </div>
                    </div>
                    <div class="box-panel p-3 sm:p-4 strategy-panel">
                        <h2 class="text-lg font-bold text-[var(--neon-gold)] tracking-widest mb-3">H·ªñ TR·ª¢ CHI·∫æN L∆Ø·ª¢C</h2>
                        <button id="advanced-analysis-btn" class="w-full bg-cyan-500/20 border border-cyan-500 text-cyan-400 font-bold py-2 px-4 rounded-md hover:bg-cyan-500/40 transition-colors mb-3">SOI C·∫¶U N√ÇNG CAO (-15 NL)</button>
                        <div class="space-y-2">
                            <label for="capital-input" class="text-sm font-semibold text-gray-300">QU·∫¢N L√ù V·ªêN (k = 1.000ƒë)</label>
                            <input type="number" id="capital-input" placeholder="Nh·∫≠p t·ªïng v·ªën..." class="w-full text-center p-2">
                            <div id="betting-suggestion" class="text-center font-bold text-lg h-8"></div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 flex flex-col gap-4 lg:gap-6">
                    <div class="flex flex-wrap justify-end gap-2 text-xs sm:text-sm box-panel p-2">
                        <div class="bg-slate-900/50 px-3 py-1 rounded">V√≤ng: <span id="round-count" class="font-bold text-white">0</span></div>
                        <div class="bg-slate-900/50 px-3 py-1 rounded">Th·∫Øng: <span id="total-wins" class="font-bold text-[var(--neon-green)]">0</span></div>
                        <div class="bg-slate-900/50 px-3 py-1 rounded">Thua: <span id="total-losses" class="font-bold text-[var(--neon-red)]">0</span></div>
                    </div>
                    <div id="bet-options-grid" class="box-panel p-2 sm:p-3 space-y-2">
                        </div>
                    <div id="history-grid" class="history-grid box-panel cv-auto"></div>
                    <div id="suggested-table-container" class="box-panel p-3 text-center cursor-pointer hover:border-amber-300 transition-colors">
                        <h3 class="text-sm text-gray-400 uppercase tracking-wider">ƒê·ªÄ XU·∫§T B√ÄN CH∆†I T·ªà L·ªÜ WIN CAO NH·∫§T</h3>
                        <p id="suggested-table-name" class="text-2xl font-bold text-[var(--neon-gold)] glow-text-gold">...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="energy-modal-lb4" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 screen">
            <div class="box-panel p-6 text-center max-w-sm w-full border-2 border-[var(--neon-red)] shadow-lg shadow-[var(--neon-red)]/30">
                <h2 class="text-2xl font-bold text-[var(--neon-red)]">H·∫æT NƒÇNG L∆Ø·ª¢NG</h2>
                <p class="my-4 text-gray-300">ƒê√É H·∫æT NƒÇNG L∆Ø·ª¢NG VUI L√íNG R√öT RA N·∫†P L·∫†I HO·∫∂C LI√äN H·ªÜ TELE @LONGBAOF168</p>
                <button id="modal-confirm-btn-lb4" class="bg-[var(--neon-green)] text-black font-bold py-2 px-8 rounded-md hover:bg-white transition-colors">X√ÅC NH·∫¨N</button>
            </div>
        </div>
    </div>
    
    <!-- SOI H·ª¶ CORE HTML -->
    <div id="soiHuScreen" class="container-screen hidden">
        <div id="video-background-soihu">
            <iframe src="https://streamable.com/e/luj9cq?autoplay=1&mute=1&loop=1" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
        </div>
        <div class="scanlines"></div>
        <div class="glitch-overlay"></div>
        <div id="lobby-container-2d" class="container-screen">
            <div class="flex flex-col items-center justify-center w-full h-full p-4">
                <button id="exitSoiHuBtn" class="back-button !top-4">‚Äπ QUAY L·∫†I</button>
                <h1 id="main-title" class="orbitron-font text-4xl md:text-5xl font-bold mb-12 text-center aurora-text tracking-widest min-h-[60px]"></h1>
                <div id="lobby-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-8 w-full max-w-5xl cv-auto"></div>
            </div>
        </div>

        <div id="app-container" class="container-screen hidden">
            <div class="relative min-h-screen flex flex-col items-center justify-center p-2 md:p-4">
                <div id="appScreen" class="w-full">
                    <header class="w-full max-w-5xl mx-auto mb-4">
                        <div class="glass-effect p-4 text-center relative">
                            <button id="backToLobbyBtn" class="back-button">‚Äπ TR·ªû V·ªÄ</button>
                            <h1 id="app-title" class="orbitron-font text-xl md:text-3xl font-bold aurora-text px-20 text-center"></h1>
                        </div>
                    </header>
                    <main id="mainContent" class="glass-effect w-full max-w-5xl mx-auto p-2 md:p-6 relative">
                        <div id="dashboardContent"></div>
                    </main>
                </div>
            </div>
        </div>

        <div id="analysis-container" class="container-screen hidden">
            <div class="relative min-h-screen flex flex-col items-center justify-center p-4">
                 <div class="analysis-content glass-effect p-6 pt-16 md:pt-6 relative">
                    <button id="backToGamesBtn" class="back-button top-4 left-4 !transform-none">‚Äπ TR·ªû V·ªÄ</button>
                    <h2 id="analysis-game-name" class="orbitron-font text-xl md:text-2xl font-bold mb-4 aurora-text text-center"></h2>
                    <img id="analysis-game-img" src="" alt="Game Image" class="w-32 h-32 md:w-48 md:h-48 mx-auto rounded-lg mb-4 border-2 border-cyan-500 shadow-lg" loading="lazy" decoding="async" fetchpriority="low">
                    <div class="analysis-data text-left space-y-2 text-base md:text-lg">
                        <p><strong>T·ªà L·ªÜ TH·∫ÆNG:</strong> <span id="analysis-win-rate" class="font-bold text-green-400"></span></p>
                        <p><strong>S·ªê V√íNG XOAY:</strong> <span id="analysis-spin-count" class="font-bold text-yellow-400"></span> v√≤ng</p>
                        <p><strong>T·ªà L·ªÜ R∆†I SCATTER:</strong> <span id="analysis-scatter-rate" class="font-bold text-purple-400"></span></p>
                    </div>
                    <!-- Golden time button remains unchanged -->
                    <div class="my-4 md:my-6">
                        <button id="golden-time-btn" class="golden-time-btn w-full">
                            <span class="block text-sm md:text-base">üåü KHUNG GI·ªú V√ÄNG üåü</span>
                            <span id="golden-time-value" class="block text-xl md:text-2xl"></span>
                        </button>
                    </div>

                    <!-- Added new sections: history, predictions, and energy -->
                    <div class="analysis-sections grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <!-- history-section removed -->
                        <!-- prediction-section removed -->
                        <!-- Energy bar spans full width on larger screens -->
                        <div id="energy-section" class="section glass-effect p-4 md:col-span-2">
                            <h3 class="orbitron-font text-lg md:text-xl font-bold aurora-text mb-2 text-center">NƒÇNG L∆Ø·ª¢NG</h3>
                            <div id="energy-bar-container-soihu" class="relative w-full bg-slate-800 rounded-full h-6 border-2 border-slate-600 p-0.5 overflow-hidden">
                                <div id="energy-bar-soihu" class="h-full rounded-full transition-all duration-500" style="width:0%; background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));"></div>
                                <span id="energy-text-soihu" class="absolute inset-0 text-xs md:text-sm font-bold flex items-center justify-center text-white" style="text-shadow: 1px 1px 2px black;">0 / 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Original financial assistant moved below new sections -->
                    <div class="financial-assistant mt-6">
                        <h3 class="orbitron-font text-lg md:text-xl mb-2 text-center">TR·ª¢ L√ù T√ÄI CH√çNH</h3>
                        <p class="text-xs text-gray-400 mb-3 text-center">Nh·∫≠p t·ªïng v·ªën ƒë·ªÉ nh·∫≠n k·∫ø ho·∫°ch chi ti·∫øt.</p>
                        <input id="plan-input" type="text" placeholder="Nh·∫≠p v·ªën (v√≠ d·ª•: 1000)" class="plan-input mb-4">
                        <button id="plan-button" class="plan-button w-full">L√äN K·∫æ HO·∫†CH</button>
                        <div id="plan-output" class="hidden"></div>
                    </div>
                 </div>
            </div>
        </div>

        <div id="scan-container" class="container-screen hidden">
            <h2 class="orbitron-font text-2xl md:text-3xl aurora-text text-center">ƒêANG QU√âT L·ªñ H·ªîNG H·ªÜ TH·ªêNG...</h2>
            <p class="text-gray-400 mt-2">Vui l√≤ng ch·ªù...</p>
        </div>

        <div id="ticker-container">
            <div id="ticker-content"></div>
        </div>
        
    </div>
    <!-- END SOI H·ª¶ CORE HTML -->
    
    <div id="core-loading-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="loading-status-text">ƒêANG N·∫†P L√ïI...</h3>
            <div id="loading-progress-bar-container">
                <div id="loading-progress-bar" style="width: 0%;"></div>
            </div>
            <p id="loading-percentage">0%</p>
        </div>
    </div>
    <div id="aquarius-modal" class="modal-overlay hidden"><div class="modal-content"><button class="close-modal-btn">X</button><h3>K√≠ch ho·∫°t Si√™u L√µi Aquarius</h3><p>VUI L√íNG NH·∫¨P M√É K√çCH HO·∫†T AQUARIUS</p><input type="text" id="aquarius-code-input" placeholder="M√É K√çCH HO·∫†T"><p id="aquarius-error" class="auth-error"></p><div class="modal-buttons"><button id="confirm-aquarius-code" class="btn-primary">X√ÅC NH·∫¨N</button><a href="https://t.me/longbaoF168" target="_blank" class="btn-style" style="border: 1px solid var(--cyan); color: var(--cyan);">LI√äN H·ªÜ</a></div></div></div>
    <div id="low-energy-modal" class="modal-overlay hidden"><div class="modal-content warning"><button class="close-modal-btn">X</button><h3>C·∫¢NH B√ÅO NƒÇNG L∆Ø·ª¢NG TH·∫§P</h3><p>L√ïI A.I ƒêANG H·∫æT NƒÇNG L∆Ø·ª¢NG - H√ÉY R√öT RA N·∫†P L·∫†I ƒê·ªÇ H·ªíI PH·ª§C L√ïI</p><div class="modal-buttons"><button class="close-modal-btn btn-primary" style="position: static;">ƒê√É HI·ªÇU</button></div></div></div>
    <div id="profile-modal" class="modal-overlay hidden"><div class="modal-content"><button class="close-modal-btn">X</button><h3>H·ªí S∆† PILOT</h3><div class="profile-tabs"><button class="profile-tab active" data-tab="profile-info">Th√¥ng tin</button><button class="profile-tab" data-tab="profile-security">B·∫£o m·∫≠t</button><button class="profile-tab" data-tab="profile-log">Nh·∫≠t k√Ω</button></div><div id="profile-info" class="profile-tab-content active"><form id="profile-form"><div class="profile-avatar-section"><img id="profile-avatar-preview" src="https://placehold.co/100x100/0A192F/00ffff?text=P" alt="Profile Avatar" loading="lazy" decoding="async" fetchpriority="low" width="100" height="100"><div class="profile-form-group" style="width: 100%;"><label for="profile-avatar-url">URL ·∫¢nh ƒê·∫°i Di·ªán</label><input type="text" id="profile-avatar-url" placeholder="https://example.com/image.png"></div></div><div class="profile-form-group"><label for="profile-f168-username">T√™n T√†i Kho·∫£n F168</label><input type="text" id="profile-f168-username" placeholder="Nh·∫≠p t√™n t√†i kho·∫£n F168"><small>Ch·ªâ ƒë∆∞·ª£c ƒë·ªïi 2 l·∫ßn/th√°ng, m·ªói l·∫ßn c√°ch nhau 15 ng√†y.</small></div><div class="profile-form-group"><label for="profile-phone">S·ªë ƒêi·ªán Tho·∫°i</label><input type="tel" id="profile-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"></div><div class="modal-buttons"><button type="submit" id="save-profile-btn" class="btn-primary">L∆ØU THAY ƒê·ªîI</button></div></form></div><div id="profile-security" class="profile-tab-content"><form id="change-password-form"><div class="profile-form-group"><label for="current-password">M·∫≠t kh·∫©u hi·ªán t·∫°i</label><input type="password" id="current-password" required></div><div class="profile-form-group"><label for="new-password">M·∫≠t kh·∫©u m·ªõi</label><input type="password" id="new-password" required></div><div class="modal-buttons"><button type="submit" class="btn-primary">ƒê·ªîI M·∫¨T KH·∫®U</button></div></form></div><div id="profile-log" class="profile-tab-content"><div id="activity-log-container"><div class="loading-spinner"></div></div></div></div></div>
    <div id="advanced-analysis-modal" class="modal-overlay hidden">
        <div class="modal-content" style="border-color: var(--neon-green); box-shadow: inset 0 0 20px rgba(0, 255, 155, 0.3), 0 0 35px var(--neon-green);">
            <button class="close-modal-btn">X</button>
            <h3 id="analysis-modal-title" style="color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green);">PH√ÇN T√çCH N√ÇNG CAO</h3>
            <div id="analysis-modal-content" class="text-left text-sm space-y-4 font-mono">
                <div>
                    <h4 class="font-bold text-cyan-400 mb-1">ƒê·ªò ·ªîN ƒê·ªäNH B√ÄN:</h4>
                    <p id="analysis-stability"></p>
                </div>
                <div>
                    <h4 class="font-bold text-cyan-400 mb-1">TH·ªêNG K√ä C·∫¶U (50 V√ÅN G·∫¶N NH·∫§T):</h4>
                    <ul id="analysis-patterns" class="list-disc list-inside"></ul>
                </div>
                <!-- analysis-next-predictions block removed -->
            </div>
        </div>
    </div>
    
    <footer id="main-footer">
        <a id="footer-contact-link" href="https://t.me/longbaoF168" target="_blank">LI√äN H·ªÜ LONG B·∫¢O</a>
        <p id="copyright">B·∫¢N QUY·ªÄN THU·ªòC V·ªÄ LONG B·∫¢O</p>
    </footer>

    <!-- Audio Elements for Soi Hu -->
    <audio id="clickSound" src="https://www.myinstants.com/media/sounds/mouse-click.mp3" preload="auto"></audio>
    <audio id="enterSound" src="https://www.myinstants.com/media/sounds/sci-fi-door-open.mp3" preload="auto"></audio>
    <audio id="hoverSound" src="https://www.myinstants.com/media/sounds/sci-fi-bleep-computer-2.mp3" preload="auto"></audio>
    <audio id="ambientSound" src="https://www.myinstants.com/media/sounds/cyberpunk-2077-ambience-music-scavenger-hideout-combat.mp3" preload="auto" loop></audio>
    <!-- lazy: VanillaTilt will be loaded on demand -->
<script type="module">// === lazy loaders ===
const __loadedScripts = new Map();
function loadScriptOnce(src) {
  if (__loadedScripts.has(src)) return __loadedScripts.get(src);
  const p = new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => resolve();
    s.onerror = (e) => reject(e);
    document.head.appendChild(s);
  });
  __loadedScripts.set(src, p);
  return p;
}

let __toneReady = false;
async function ensureToneAndInit() {
  if (__toneReady) return;
  await loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js');
  if (typeof Tone === 'undefined') return;
  if (typeof initializeSounds === 'function') initializeSounds();
  __toneReady = true;
  console.log('[perf] Tone.js loaded lazily');
}

let __vtReady = false;
async function ensureVanillaTilt() {
  if (__vtReady) return;
  await loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js');
  if (window.VanillaTilt) {
    const targets = document.querySelectorAll('#lobby-grid .lobby-card, [data-tilt]');
    if (targets.length) {
      /* lazy */ ensureVanillaTilt();
__vtReady = true;
      console.log('[perf] VanillaTilt initialized lazily on', targets.length, 'elements');
    }
  }
}

// Trigger VT load on first interaction with lobby-grid
document.addEventListener('DOMContentLoaded', () => {
  const lobbyGrid = document.querySelector('#lobby-grid');
  if (!lobbyGrid) return;
  const trigger = () => { ensureVanillaTilt(); lobbyGrid.removeEventListener('mouseenter', trigger); lobbyGrid.removeEventListener('touchstart', trigger); };
  lobbyGrid.addEventListener('mouseenter', trigger, { once: true, passive: true });
  lobbyGrid.addEventListener('touchstart', trigger, { once: true, passive: true });
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      const rect = lobbyGrid.getBoundingClientRect();
      if (rect.top < innerHeight && rect.bottom > 0) ensureVanillaTilt();
    }, {timeout: 2000});
  }
});

// Defer Tone init until first user gesture (required by browsers anyway)
['pointerdown','touchstart','mousedown','keydown'].forEach(evt => {
  window.addEventListener(evt, function onFirstGesture() {
    ensureToneAndInit();
    window.removeEventListener(evt, onFirstGesture, {capture:false});
  }, { once: true, passive: true });
});
// === end lazy loaders ===


        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            updatePassword, EmailAuthProvider, reauthenticateWithCredential
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, Timestamp,
            collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyCHDzGbXmHNWKL2UtRm57vPRVxZb31dHto",
                authDomain: "long-bao-tool-ai.firebaseapp.com",
                projectId: "long-bao-tool-ai",
                storageBucket: "long-bao-tool-ai.appspot.com",
                messagingSenderId: "259613170671",
                appId: "1:259613170671:web:6fe2467879c01da52b41a",
            },
            authDomainSuffix: "@long-bao-tool-ai.web.app",
            energy: {
                initial: 5,
                max: 100,
                costs: {
                    longBaoIV: 5,
                    geminiChat: 5,
                    advancedAnalysis: 15,
                    soiHuScan: 10,
                }
            },
            ai_cores: [
                { id: 'longbao_iv', name: 'LongBao Th·∫ø H·ªá IV', description: 'ƒê∆∞·ª£c ph√°t tri·ªÉn t·ª´ c√°c GPU Ndivia th·∫ø h·ªá m·ªõi, x√¢m nh·∫≠p v√¥ s·∫£nh game ƒë·ªÉ ph√¢n t√≠ch v√† ƒë∆∞a ra l·ª±a ch·ªçn t·ªët nh·∫•t cho ng∆∞·ªùi d√πng.', gif: 'https://giphy.com/embed/T1ajxi525sbRkVWoUR' },
                { id: 'soi_hu', name: 'TOOL SƒÇN H·ª¶', description: 'C√¥ng ngh·ªá SƒÇN H·ª¶ gi√∫p ng∆∞·ªùi ch∆°i big win 1 c√°ch d·ªÖ d√†ng.', gif: 'https://giphy.com/embed/jLgkxdMy5HiIPXMUAD' },
                { id: 'yian', name: 'Yian Soi L√° B√†i', description: 'C√¥ng ngh·ªá t∆∞∆°ng lai ƒë·ªôc quy·ªÅn - ƒë∆∞·ª£c ph√°t tri·ªÉn t·ª´ h·ªá th·ªëng SVB n·ªïi ti·∫øng c·ªßa c√°c hacker. Gi·ªù ƒë√¢y soi l√° b√†i kh√¥ng ph·∫£i l√† t∆∞·ªüng t∆∞·ª£ng n·ªØa!', gif: 'https://giphy.com/embed/hi9Jsq05bluzriledc', externalUrl: 'yian_core.html' },
                { id: 'aquarius', name: 'Si√™u L√µi Aquarius', description: 'ƒê∆∞·ª£c t·∫°o l√™n t·ª´ A.I th√¥ng minh nh·∫•t th·∫ø gi·ªõi Grok IV - T·ªâ l·ªá th·∫Øng 99%. X1000 l·∫ßn t√†i kho·∫£n trong 1 ƒë√™m kh√¥ng c√≤n l√† m∆°.', gif: 'https://giphy.com/embed/Jfu7aUAHd1C8XNuCSl', externalUrl: 'https://www.aquariusvip.site' },
                { id: 'tool_con_so', name: 'HACK S·ªî X·ªî', description: 'TH·ª¢ SƒÇN S·ªê ƒê·ªÄ C·ª¶A AE ƒê√ÇY', gif: 'https://giphy.com/embed/e66t3zSqXSHvGMxDRt' },
            ],
            longbao_iv: {
                prediction_interval: 25000,
                main_outcomes: ['NH√Ä CON', 'NH√Ä C√ÅI'],
                sub_outcomes: ['Con ƒë√¥i', 'Ph∆∞·ª£ng ƒë√¥i', 'T√†i', 'X·ªâu', 'Huy·ªÅn v≈©', 'C√°i ƒë√¥i', 'Long B·∫£o Player', 'Long B·∫£o Banker'],
            },
            // Soi H·ªß game data
            soiHuGames: {
                 lobbyGameList: [
                    { id: 'jili', name: 'S·∫¢NH JILI', imageUrl: 'https://i.ibb.co/BVDMCp2b/S-NH-JILI.jpg' },
                    { id: 'mg', name: 'S·∫¢NH MG', imageUrl: 'https://i.ibb.co/pv4SDc44/S-NH-MG.jpg' },
                    { id: 'pp', name: 'S·∫¢NH PP', imageUrl: 'https://i.ibb.co/Z12RBjkr/S-NH-PP.jpg' },
                    { id: 'fc', name: 'S·∫¢NH FC', imageUrl: 'https://i.ibb.co/35QBkLdK/S-NH-FC.jpg' },
                    { id: 'pg', name: 'S·∫¢NH PG', imageUrl: 'https://i.ibb.co/20Fvmsjr/S-NH-PG.jpg' },
                    { id: 'g168', name: 'S·∫¢NH 168GAMING', imageUrl: 'https://i.ibb.co/8hNZTQq/S-NH-168-GAMING.jpg' }
                ],
                allGames: {
                    pg: [
                        { id: 'pg-btl', name: 'BƒÉng Thi·∫øu L√¢m', imageUrl: 'https://i.ibb.co/vvxMZM7y/B-NG-THI-U-L-M.jpg' },
                        { id: 'pg-cl', name: 'CƒÉn Long', imageUrl: 'https://i.ibb.co/d4PgChRN/C-N-LONG.jpg' },
                        { id: 'pg-ctl', name: 'C√¢y T√†i L·ªôc', imageUrl: 'https://i.ibb.co/JW6x6xZB/C-Y-T-I-L-C.jpg' },
                        { id: 'pg-cmqk', name: 'C·ªó M√°y Qu·∫£ng Khai', imageUrl: 'https://i.ibb.co/Rk4kLnM0/C-B-QU-NG-KH-N.jpg' },
                        { id: 'pg-nmc2', name: 'Ng√¥i M·ªô C·ªï 2', imageUrl: 'https://i.ibb.co/q3NB7cnG/NG-M-T-CH-C-2.jpg' },
                        { id: 'pg-nmc', name: 'Ng√¥i M·ªô C·ªï', imageUrl: 'https://i.ibb.co/TBxS02sT/NG-M-T-CH-C.jpg' },
                        { id: 'pg-gmmc', name: 'Gi·∫•c M∆° Ma Cao', imageUrl: 'https://i.ibb.co/jkSmjLqj/GI-C-M-MA-CAO.jpg' },
                        { id: 'pg-klmn', name: 'K·ª≥ L√¢n M√°ch N∆∞·ªõc', imageUrl: 'https://i.ibb.co/NhYJDKS/K-L-N-M-CH-N-C.jpg' },
                        { id: 'pg-kbaz', name: 'Kho B√°u Aztec', imageUrl: 'https://i.ibb.co/jkLrcK1p/KHO-B-U-AZTEC.jpg' },
                        { id: 'pg-ls2', name: 'Long Sinh 2', imageUrl: 'https://i.ibb.co/k2bmtM8z/LONG-SINH-2.jpg' },
                        { id: 'pg-ls', name: 'Long Sinh', imageUrl: 'https://i.ibb.co/QvGj12V5/LONG-SINH.jpg' },
                        { id: 'pg-md1', name: 'Medusa', imageUrl: 'https://i.ibb.co/TDhBCrfH/MEDUSA-1.jpg' },
                        { id: 'pg-md2', name: 'Medusa 2', imageUrl: 'https://i.ibb.co/3mN22vgX/MEDUSA-2.jpg' },
                        { id: 'pg-nmm', name: 'Neko May M·∫Øn', imageUrl: 'https://i.ibb.co/WWrKDRbJ/NEKO-MAY-M-N.jpg' },
                        { id: 'pg-njdd', name: 'Ninja ƒê·ªëi ƒê·∫ßu', imageUrl: 'https://i.ibb.co/Xr70c1Rd/NINJA-I-U.jpg' },
                        { id: 'pg-nvdmt', name: 'Nh√† V√¥ ƒê·ªãch Muay Th√°i', imageUrl: 'https://i.ibb.co/3y5z3rTj/NH-V-CH-MUAWAY.jpg' },
                        { id: 'pg-ph', name: 'Ph∆∞·ª£ng Ho√†ng', imageUrl: 'https://i.ibb.co/zH5QZdmt/PH-NG-HO-NG.jpg' },
                        { id: 'pg-qctt', name: 'Quy·∫øt Chi·∫øn Ti·ªÅn Th∆∞·ªüng', imageUrl: 'https://i.ibb.co/5XhYW8wC/QUY-T-CHI-N-TI-N-TH-NG.jpg' },
                        { id: 'pg-sac', name: 'S√°ch Ai C·∫≠p', imageUrl: 'https://i.ibb.co/RGwGN69K/S-CH-AI-C-P.jpg' },
                        { id: 'pg-tmm', name: 'Th·∫ßn May M·∫Øn', imageUrl: 'https://i.ibb.co/Vcgyh5k1/TH-N-MAY-M-N.jpg' },
                        { id: 'pg-thomm', name: 'Th·ªè May M·∫Øn', imageUrl: 'https://i.ibb.co/XrP9sLqM/TH-MAY-M-N.jpg' },
                        { id: 'pg-tstt', name: 'Th·ª£ SƒÉn Ti·ªÅn Th∆∞·ªüng', imageUrl: 'https://i.ibb.co/jZTwFKky/TH-S-N-TI-N-TH-NG.jpg' },
                        { id: 'pg-www', name: 'Win Win Won', imageUrl: 'https://i.ibb.co/8LDmXF4s/WIN-WIN-WON.jpg' },
                        { id: 'pg-zb', name: 'Zombie Braker', imageUrl: 'https://i.ibb.co/Z1G6GX3s/ZOMBIE-BRAKER.jpg' }
                    ],
                    pp: [
                        { id: 'pp-btg', name: 'B√†i T·∫•n G', imageUrl: 'https://i.ibb.co/dwq4PFNG/B-T-G.jpg' },
                        { id: 'pp-bl', name: 'Bi·ªÉn L·ª≠a', imageUrl: 'https://i.ibb.co/N6fcyVKY/BI-N-L-A.jpg' },
                        { id: 'pp-bb', name: 'Big Bass', imageUrl: 'https://i.ibb.co/cKMMs4Jc/BIG-BASS.jpg' },
                        { id: 'pp-btv', name: 'B·ªØa Ti·ªác V√†ng', imageUrl: 'https://i.ibb.co/jkKTvGh0/B-A-TI-C-V-NG.jpg' },
                        { id: 'pp-cvv', name: 'C√° V√†ng V√†ng', imageUrl: 'https://i.ibb.co/WNVBnVMC/C-U-V-NG-V-NG.jpg' },
                        { id: 'pp-cbl', name: 'C·ªè Ba L√°', imageUrl: 'https://i.ibb.co/p6cC0QPw/C-BA-L.jpg' },
                        { id: 'pp-cmcc', name: 'Con M·∫Øt C·ªßa Cleo', imageUrl: 'https://i.ibb.co/6L7wwFc/CON-M-T-C-A-CLEO.jpg' },
                        { id: 'pp-cv', name: 'C·ªïng Valhalla', imageUrl: 'https://i.ibb.co/tw055dyd/C-NG-VAHALA.jpg' },
                        { id: 'pp-dbb', name: 'ƒê·∫≠u B·∫Øp B·∫Øn', imageUrl: 'https://i.ibb.co/jkdT7DzJ/U-B-P-B-N.jpg' },
                        { id: 'pp-d1000', name: 'ƒê∆∞·ªùng 1000', imageUrl: 'https://i.ibb.co/wFpWCT60/NG-1000.jpg' },
                        { id: 'pp-kcc5', name: 'K·∫πo Cu·ªëi C√πng 5', imageUrl: 'https://i.ibb.co/pBBf6JyJ/K-CU-I-C-NG-5.jpg' },
                        { id: 'pp-kttm', name: 'Ki·ªÉm Tra Ti·ªÅn M·∫∑t', imageUrl: 'https://i.ibb.co/HDvttT5k/KI-M-TRA-TI-N-M-T.jpg' },
                        { id: 'pp-kv', name: 'Khoan V√†ng', imageUrl: 'https://i.ibb.co/mFv54DMh/KHOAN-V-NG.jpg' },
                        { id: 'pp-lhcg', name: 'Linh H·ªìn C·ªßa Giza', imageUrl: 'https://i.ibb.co/HfsvLRs4/LINH-H-N-C-A-GI.jpg' },
                        { id: 'pp-mw2', name: 'Mahjong Win 2', imageUrl: 'https://i.ibb.co/s9T2vf3f/MAHJONG-WIN-2.jpg' },
                        { id: 'pp-nhd', name: 'N·ªØ Ho√†ng Disco', imageUrl: 'https://i.ibb.co/C33zRYJn/N-HO-NG-DISCO.jpg' },
                        { id: 'pp-q', name: 'Queenie', imageUrl: 'https://i.ibb.co/w2Rmv4v/QUEENIE.jpg' },
                        { id: 'pp-rhm', name: 'Ra H√†ng M·∫°nh', imageUrl: 'https://i.ibb.co/4n2fGJyV/RA-H-NG-M-NH.jpg' },
                        { id: 'pp-s4', name: 'Samurai 4', imageUrl: 'https://i.ibb.co/JFz4xLTr/SAMURAI-4.jpg' },
                        { id: 'pp-st', name: 'S√¢u Th·∫≥m', imageUrl: 'https://i.ibb.co/kgHN897K/SAU-TH-M.jpg' },
                        { id: 'pp-sm', name: 'Spaceman', imageUrl: 'https://i.ibb.co/dJ0xkN5M/SPACEMAN.jpg' },
                        { id: 'pp-sr', name: 'Sugar Rush', imageUrl: 'https://i.ibb.co/H38sT3v/SUGAR-RUSH.jpg' },
                        { id: 'pp-ttt', name: 'Tic Tac Take', imageUrl: 'https://i.ibb.co/1tFhkS5P/TIC-TAC-TAKE.jpg' },
                        { id: 'pp-vmg', name: 'V·∫≠n May Giza', imageUrl: 'https://i.ibb.co/zVNrXfYt/V-N-MAY-GIZA.jpg' },
                        { id: 'pp-vtt', name: 'Vua Th·∫ßn T√†i', imageUrl: 'https://i.ibb.co/VYTHbJQ0/VUA-TH-N-T-I.jpg' }
                    ],
                    jili: [
                        { id: 'jili-7k', name: '7 Kh√¥ng', imageUrl: 'https://i.ibb.co/23VXBSmV/7-KH-NG.jpg' },
                        { id: 'jili-ali', name: 'Alibaba', imageUrl: 'https://i.ibb.co/ch3H3R8q/ALIBABA.jpg' },
                        { id: 'jili-bpt', name: 'B·∫£ng Phong Th·∫ßn', imageUrl: 'https://i.ibb.co/v6W0SWz9/B-NG-PHONG-TH-N.jpg' },
                        { id: 'jili-bmm', name: 'Bom May M·∫Øn', imageUrl: 'https://i.ibb.co/TDMhvpMT/B-O-M-MAY-M-N.jpg' },
                        { id: 'jili-btk', name: 'B·∫£o Th·∫°ch Kala', imageUrl: 'https://i.ibb.co/qLJrfZFX/B-O-TH-CH-KALA.jpg' },
                        { id: 'jili-cpt', name: 'C√¢y Ph√°t T√†i', imageUrl: 'https://i.ibb.co/rR7HVD4X/C-Y-PH-T-T-I.jpg' },
                        { id: 'jili-ma', name: 'Mega Ace', imageUrl: 'https://i.ibb.co/DfqBLzpz/MEGA-ACE.jpg' },
                        { id: 'jili-nmm2', name: 'Ng·ª±a May M·∫Øn 2', imageUrl: 'https://i.ibb.co/bjbyqqpt/NG-C-MAY-M-N-2.jpg' },
                        { id: 'jili-nmm3', name: 'Ng·ª±a May M·∫Øn 3', imageUrl: 'https://i.ibb.co/V0qRWbkD/NG-C-MAY-M-N-3.jpg' },
                        { id: 'jili-qn', name: 'Qu·∫°t N√≥ng', imageUrl: 'https://i.ibb.co/qLdsjWx6/QU-T-N-NGt.jpg' },
                        { id: 'jili-qvt', name: 'Quang V√¢n Tr∆∞·ªùng', imageUrl: 'https://i.ibb.co/MD2k5vFL/QUANG-V-N-TR-NG.jpg' },
                        { id: 'jili-qv', name: 'Quy·ªÅn V∆∞∆°ng', imageUrl: 'https://i.ibb.co/zWQsxZbN/QUY-N-V-NG.jpg' },
                        { id: 'jili-snt', name: 'Si√™u Nh√¢n Tung', imageUrl: 'https://i.ibb.co/SDgMVbQH/SI-U-N-TUNG.jpg' },
                        { id: 'jili-snb', name: 'Si√™u Niu Bi', imageUrl: 'https://i.ibb.co/8g7jpzf4/SIU-NIU-BI.jpg' },
                        { id: 'jili-sa1', name: 'Super Ace 1', imageUrl: 'https://i.ibb.co/DHsVKdFs/SUPER-ACE-1.jpg' },
                        { id: 'jili-sa', name: 'Super Ace', imageUrl: 'https://i.ibb.co/gbDF52kK/SUPER-ACE.jpg' },
                        { id: 'jili-ttvn', name: 'Truy·ªÅn Thuy·∫øt Vua Ng·ª±a', imageUrl: 'https://i.ibb.co/5hdQ2tq4/TRUY-N-THUY-T-VUA-NGUt.jpg' },
                        { id: 'jili-vltd', name: 'V√µ Long Tranh ƒê·∫•u', imageUrl: 'https://i.ibb.co/93dVTWYS/V-LONG-TRANH-U.jpg' },
                        { id: 'jili-vrx', name: 'Vua R·ªìng Xanh', imageUrl: 'https://i.ibb.co/b5jLXh4j/VUA-R-NG-XANH.jpg' }
                    ],
                    mg: [
                        { id: 'mg-9mnl', name: '9 M·∫∑t N·∫° L·ª≠a', imageUrl: 'https://i.ibb.co/gbnR6Cmc/9-M-T-N-L-A.jpg' },
                        { id: 'mg-nhv', name: 'N·ªØ H√≠ V√†ng', imageUrl: 'https://i.ibb.co/7fBQ8zN/N-CH-I-V-NG.jpg' },
                        { id: 'mg-nh', name: 'N·ªØ H√≠', imageUrl: 'https://i.ibb.co/PGXmBX21/N-CH-I.jpg' },
                        { id: 'mg-bs', name: 'B·∫≠c Stealing', imageUrl: 'https://i.ibb.co/SXHwQ5hM/B-C-STEALING.jpg' },
                        { id: 'mg-css', name: 'C·∫∑p Song Sinh', imageUrl: 'https://i.ibb.co/prXtjPkX/C-P-SONG-SINH.jpg' },
                        { id: 'mg-cr', name: 'Cu·ªën Retro', imageUrl: 'https://i.ibb.co/cKm7WpSW/CU-N-RETRO.jpg' },
                        { id: 'mg-ctn', name: 'Cu·ªën T√†i NƒÉng', imageUrl: 'https://i.ibb.co/WNwLFNHy/CU-N-T-I-N-NG.jpg' },
                        { id: 'mg-jss', name: 'Jackpot Song Sinh', imageUrl: 'https://i.ibb.co/8gDTGYDN/JACKPOT-SONG-SINH.jpg' },
                        { id: 'mg-kbcs', name: 'Kho B√°u C·ªßa S√©t', imageUrl: 'https://i.ibb.co/13Kn4Tm/KHO-B-U-C-A-S-T.jpg' },
                        { id: 'mg-nas', name: 'Nh·∫´n √Ånh Sao', imageUrl: 'https://i.ibb.co/2GjZZXj/N-H-N-NH-SAO.jpg' },
                        { id: 'mg-nhc', name: 'N·ªØ Ho√†ng Crystal', imageUrl: 'https://i.ibb.co/ZphxN7c9/N-HO-NG-CRYSTAL.jpg' },
                        { id: 'mg-nsb', name: 'Ng√¥i Sao BƒÉng', imageUrl: 'https://i.ibb.co/whkymX14/NG-I-SAO-B-NG.jpg' },
                        { id: 'mg-nsbr', name: 'Ng√¥i Sao BƒÉng R', imageUrl: 'https://i.ibb.co/mVgJ3LTD/NG-I-SAO-B-NG-R.jpg' },
                        { id: 'mg-nspnl', name: 'Ng√¥i Sao Phim Ng∆∞·ªùi L·ªõn', imageUrl: 'https://i.ibb.co/dshYdQRt/NG-I-SAO-PHIM-NG-I-L-N.jpg' },
                        { id: 'mg-nhm', name: 'Ng√¥i Nh√† Ma', imageUrl: 'https://i.ibb.co/1YmJsJgT/NG-I-H-M-M.jpg' },
                        { id: 'mg-pdc', name: 'Ph√°o ƒê√†i C·ªï', imageUrl: 'https://i.ibb.co/ymT12nnT/PH-O-I-C-I.jpg' },
                        { id: 'mg-rxsn', name: 'R·∫°p Xi·∫øc S√¥i N·ªïi', imageUrl: 'https://i.ibb.co/LXKmYs4R/R-P-XI-C-SO-N.jpg' },
                        { id: 'mg-ss2', name: 'S·∫•m S√©t 2', imageUrl: 'https://i.ibb.co/MDHftCZ8/S-M-S-T-2.jpg' },
                        { id: 'mg-st', name: 'S√©t Tƒ©nh', imageUrl: 'https://i.ibb.co/RTkcBcG1/S-T-NH.jpg' },
                        { id: 'mg-tq', name: 'T·ªïng Qu√¢n', imageUrl: 'https://i.ibb.co/Q3bK60W7/T-NG-QU-N.jpg' },
                        { id: 'mg-tr', name: 'Thuy·ªÅn R·ªìng', imageUrl: 'https://i.ibb.co/vxMCpVJt/THUY-N-R-NG.jpg' },
                        { id: 'mg-vctt', name: 'V·∫≠t Ch·∫•t T·ªëi', imageUrl: 'https://i.ibb.co/4ZLNHsn7/V-T-CH-T-T-I.jpg' },
                        { id: 'mg-ws', name: 'Win Sum', imageUrl: 'https://i.ibb.co/5W85FZnk/WIN-SUM.jpg' }
                    ],
                    fc: [
                        { id: 'fc-bkng', name: 'B√£o K√≠ch Ng·ªçt Ng√†o', imageUrl: 'https://i.ibb.co/CKWKRb9m/B-O-K-CH-NG-NG-T.jpg' },
                        { id: 'fc-ctqm', name: 'Cao Th·ªß Quy·∫øt M√¥n', imageUrl: 'https://i.ibb.co/jkZJQj7g/CAO-TH-QU-T-M-N.jpg' },
                        { id: 'fc-cttt', name: 'Cao Th·ªß Tr√°o Th√°p', imageUrl: 'https://i.ibb.co/svrBjthV/CAO-TH-TR-O-TH-P.jpg' },
                        { id: 'fc-cttl', name: 'C·∫©m Th·∫°ch T√†i L·ªôc', imageUrl: 'https://i.ibb.co/xK8Qzsb6/C-M-T-I-L-C.jpg' },
                        { id: 'fc-ccdd', name: 'C√° C∆∞·ª£c D·ªã D·∫°ng', imageUrl: 'https://i.ibb.co/KkbrhG8/C-A-C-I-D-I-D-O.jpg' },
                        { id: 'fc-cn2', name: 'Cu·ªìng Nhi·ªát 2', imageUrl: 'https://i.ibb.co/cBbDhnP/CU-I-N-M-2.jpg' },
                        { id: 'fc-ccw', name: 'Ch√≥ Chiwawa', imageUrl: 'https://i.ibb.co/DDqXh6HN/CH-CHIWAWA.jpg' },
                        { id: 'fc-dcp', name: 'D·∫°o Ch∆°i Ph·ªë', imageUrl: 'https://i.ibb.co/4ZSQskqC/D-O-CH-I-PH-M.jpg' },
                        { id: 'fc-cn1', name: 'Cu·ªìng Nhi·ªát 1', imageUrl: 'https://i.ibb.co/whrTjQ4T/U-N-M-1.jpg' },
                        { id: 'fc-htinca', name: 'Huy·ªÅn Tho·∫°i Inca', imageUrl: 'https://i.ibb.co/pBPGy5pW/HUY-N-THO-I-INCA.jpg' },
                        { id: 'fc-hvt', name: 'H·ªôp V√¥ Ti·ªám', imageUrl: 'https://i.ibb.co/Mkd2XyxF/H-NG-V-TI-N.jpg' },
                        { id: 'fc-kltn', name: 'Kim Linh Th·∫ßn N·ªØ', imageUrl: 'https://i.ibb.co/k2hMhN9W/KIM-LINH-TH-N-N.jpg' },
                        { id: 'fc-kbac', name: 'Kho B√°u Ai C·∫≠p', imageUrl: 'https://i.ibb.co/ybk3qQ7/KHO-B-U-AI-C-P.jpg' },
                        { id: 'fc-l9', name: 'Lucky 9', imageUrl: 'https://i.ibb.co/bgPH3prD/LUCKY-9.jpg' },
                        { id: 'fc-mtg', name: 'Ma Thu·∫≠t Gh√©p', imageUrl: 'https://i.ibb.co/RTb6pNrG/MA-THU-T-GH-P.jpg' },
                        { id: 'fc-nhinca', name: 'N·ªØ Ho√†ng Inca', imageUrl: 'https://i.ibb.co/Lz5HgSjf/N-HO-NG-INCA.jpg' },
                        { id: 'fc-ntv', name: 'N·ªØ Th·∫ßn V√†ng', imageUrl: 'https://i.ibb.co/9kWWw6FB/N-TH-N-V.jpg' },
                        { id: 'fc-ntdt', name: 'Nguy√™n T·ªë D∆∞∆°ng Tr·∫£o', imageUrl: 'https://i.ibb.co/xSw3cHQ2/NGUY-N-T-D-NG-TR-O.jpg' },
                        { id: 'fc-prtl', name: 'Ph√°o R·ªìng T√†i L·ªôc', imageUrl: 'https://i.ibb.co/dwsnJ879/PH-O-R-NG-T-I-L-C.jpg' },
                        { id: 'fc-rh', name: 'Robinhood', imageUrl: 'https://i.ibb.co/Pvz7LhXx/ROBINHOOD.jpg' },
                        { id: 'fc-ttp', name: 'Th·∫ßn T√†i Phi√™n', imageUrl: 'https://i.ibb.co/SD4npyZZ/TH-N-T-I-PHI-N.jpg' },
                        { id: 'fc-th', name: 'Tr√¢u Ho√†ng', imageUrl: 'https://i.ibb.co/1tfZWBg0/TR-U-HOANG.jpg' },
                        { id: 'fc-zeus', name: 'Zeus', imageUrl: 'https://i.ibb.co/Jj6TXgr7/ZUES.jpg' }
                    ],
                    g168: [
                        { id: 'g168-hd', name: 'Heo Disco', imageUrl: 'https://i.ibb.co/kVTNMWs1/HEO-DISCO.jpg' },
                        { id: 'g168-ssdp', name: 'Si√™u S·ªëc D·ªØ Ph∆∞·ª£ng', imageUrl: 'https://i.ibb.co/tTp9HLt7/SI-U-S-C-D-PH-NG.jpg' },
                        { id: 'g168-spw', name: 'S∆∞ Ph·ª• Wanda', imageUrl: 'https://i.ibb.co/xKjpxsfF/S-PH-WANDA.jpg' },
                        { id: 'g168-ttsk', name: 'Th·∫•t Tinh Sung Kh√≠', imageUrl: 'https://i.ibb.co/Zzn7S1Yq/TH-T-S-N-KHO-I.jpg' },
                        { id: 'g168-ttsk2', name: 'Th·∫•t Tinh Sung Kh√≠ 2', imageUrl: 'https://i.ibb.co/m5bBLhcL/TH-T-S-NG-KHO-I-2.jpg' },
                        { id: 'g168-mtc', name: 'M·∫°t Ch∆∞·ª£c', imageUrl: 'https://i.ibb.co/RpD4mJM0/M-T-CH-C.jpg' },
                        { id: 'g168-mtc2', name: 'M·∫°t Ch∆∞·ª£c 2', imageUrl: 'https://i.ibb.co/HTDTCffV/M-T-CH-T-2.jpg' }
                    ]
                }
            }
        };

        // --- DEFAULT CONFIG (FALLBACK) ---
        const DEFAULT_CONFIG = {
            longbao_iv: {
                tables: [
                    'BACARAT C04', 'BACARAT C05', 'BACARAT C06', 'BACARAT C07', 'BACARAT C01', 'BACARAT C02', 'BACARAT C03', 'BACARAT C08', 'BACARAT C09', 'BACARAT C10',
                    'BACARAT 1', 'BACARAT 2', 'BACARAT 3', 'BACARAT 4', 'BACARAT 5', 'BACARAT 7', 'BACARAT 8', 'BACARAT 9'
                ]
            }
        };
        const randomNamesSoiHu = [
            "tuanlong9a", "ngdinh9", "Okvipanhdi", "hieublack1", "minhpro7", "kimcuong88", "daicat666", "phuocloc99",
            "hoangtu777", "congchua8", "thienmenh", "anhthao1", "baodung2", "chuhieu5", "danghoa", "ducchinh8", "hoangminh9a",
            "huyquang6", "lananh7a", "minhhang5", "phuonglinh", "quanghuy3", "thanhmai2", "tranthanh", "tuyetngan",
            "vietan1", "xuanhieu", "yennhi4", "dinhnghia", "nguyenkhang", "hoangnam", "phuongnga", "thanhhai99",
            "trandat8", "minhthuy", "phuclinh", "anhkhoa", "thuyduong", "nguyentran", "bichvan", "quangtrung", "lanphuong",
            "thaole99", "kimanh", "minhtai", "vantuan", "xuanmai", "hoahong", "maianh", "ngoctram", "thanhson",
            "longvu", "phuongvy", "tranduc", "vietanh", "hoanghai", "minhanh", "thienan", "duykhanh", "hoangngan",
            "vanphu", "thanhlong", "khacviet", "trangnhung", "ngochuy", "tuyetma", "minhlong", "dieulinh", "hoangviet",
            "thaoha", "hieulong", "phuongthao", "trunghieu", "quynhnhu", "thuhien", "vannam", "xuanhien", "maivang",
            "dinhhieu", "hoangduy", "minhnguyet", "thanhbinh", "baongoc", "dieuanh", "kimdung", "hongngoc", "xuanlan",
            "thuytien", "vantuananh", "hoangthuy", "minhquan", "linhchi", "trangminh", "hoangphong", "tuananh", "xuanmai",
            "thanhthuy", "phuonganh"
        ];
        
        // --- FIREBASE INITIALIZATION ---
        const fbApp = initializeApp(CONFIG.firebase);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // --- GLOBAL STATE ---
        let currentUserData = null;
        let unsubscribeUser;
        let wasEnergyLow = false;
        let soundsReady = false;
        let globalUpdateInterval;
        let chatHistory = [];
        let ytPlayer, isYtReady = false;
        const sound = {};
        let randomNotifierTimeout;
        let hotTables = {};
        let userCapital = 0;
        let winRateInterval;
        let currentLobby = null;

        // --- DOM Elements ---
        const DOMElements = {
            authScreen: document.getElementById('authScreen'),
            aiCoreSelectionScreen: document.getElementById('aiCoreSelectionScreen'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            showRegisterLink: document.getElementById('showRegisterLink'),
            showLoginLink: document.getElementById('showLoginLink'),
            loginUsernameInput: document.getElementById('login-username'),
            loginPasswordInput: document.getElementById('login-password'),
            loginBtn: document.getElementById('loginBtn'),
            coreOptionsContainer: document.getElementById('core-cards-wrapper'),
            prevCoreBtn: document.getElementById('prev-core-btn'),
            nextCoreBtn: document.getElementById('next-core-btn'),
            userInfoBar: document.getElementById('user-info-bar'),
            userPilotSpan: document.getElementById('user-pilot'),
            // Th√™m span hi·ªÉn th·ªã c·∫•p b·∫≠c t√†i kho·∫£n b√™n c·∫°nh t√™n pilot
            userLevelSpan: document.getElementById('user-level'),
            userEnergySpan: document.getElementById('user-energy'),
            userAvatarImg: document.getElementById('user-avatar'),
            logoutBtn: document.getElementById('logout-btn'),
            chatRobotContainer: document.getElementById('chat-robot-container'),
            robotSpeechBubble: document.getElementById('robot-speech-bubble'),
            chatWindowContainer: document.getElementById('chat-window-container'),
            chatMessages: document.getElementById('chat-messages'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            aquariusModal: document.getElementById('aquarius-modal'),
            confirmAquariusCodeBtn: document.getElementById('confirm-aquarius-code'),
            aquariusCodeInput: document.getElementById('aquarius-code-input'),
            aquariusError: document.getElementById('aquarius-error'),
            lowEnergyModal: document.getElementById('low-energy-modal'),
            coreLoadingModal: document.getElementById('core-loading-modal'),
            loadingStatusText: document.getElementById('loading-status-text'),
            loadingProgressBar: document.getElementById('loading-progress-bar'),
            loadingPercentage: document.getElementById('loading-percentage'),
            profileModal: document.getElementById('profile-modal'),
            profileBtn: document.getElementById('profile-btn'),
            profileTabs: document.querySelectorAll('.profile-tab'),
            profileTabContents: document.querySelectorAll('.profile-tab-content'),
            activityLogContainer: document.getElementById('activity-log-container'),
            longbaoIVScreen: document.getElementById('longbaoIVScreen'),
            exitLongbaoBtnTables: document.getElementById('exit-longbao-btn-tables'),
            tableSelectionScreen: document.getElementById('table-selection-screen'),
            toolScreen: document.getElementById('tool-screen'),
            tableListContainer: document.getElementById('table-list'),
            backToTablesBtn: document.getElementById('back-to-tables-btn'),
            toolTitle: document.getElementById('tool-title'),
            mainPredictionText: document.getElementById('main-prediction-text'),
            subPredictionText: document.getElementById('sub-prediction-text'),
            historyGrid: document.getElementById('history-grid'),
            roundCountEl: document.getElementById('round-count'),
            totalWinsEl: document.getElementById('total-wins'),
            totalLossesEl: document.getElementById('total-losses'),
            progressCircle: document.getElementById('progress-circle'),
            progressValue: document.getElementById('progress-value'),
            countdownBar: document.getElementById('countdown-bar'),
            betOptionsGrid: document.getElementById('bet-options-grid'),
            suggestedTableNameEl: document.getElementById('suggested-table-name'),
            energyBar: document.getElementById('energy-bar'),
            energyTextLB4: document.getElementById('energy-text-lb4'),
            suggestedTableContainer: document.getElementById('suggested-table-container'),
            energyModalLB4: document.getElementById('energy-modal-lb4'),
            modalConfirmBtnLB4: document.getElementById('modal-confirm-btn-lb4'),
            shockwaveContainer: document.getElementById('shockwave-container'),
            aiReasoning: document.getElementById('ai-reasoning'),
            advancedAnalysisBtn: document.getElementById('advanced-analysis-btn'),
            capitalInput: document.getElementById('capital-input'),
            bettingSuggestion: document.getElementById('betting-suggestion'),
            advancedAnalysisModal: document.getElementById('advanced-analysis-modal'),
            analysisModalTitle: document.getElementById('analysis-modal-title'),
            analysisStability: document.getElementById('analysis-stability'),
            analysisPatterns: document.getElementById('analysis-patterns'),

            // New Soi H·ªß Elements
            soiHuScreen: document.getElementById('soiHuScreen'),
            lobbyContainerSoiHu: document.getElementById('lobby-container-2d'),
            appContainerSoiHu: document.getElementById('app-container'),
            analysisContainerSoiHu: document.getElementById('analysis-container'),
            scanContainerSoiHu: document.getElementById('scan-container'),
            lobbyGridSoiHu: document.getElementById('lobby-grid'),
            backToLobbyBtnSoiHu: document.getElementById('backToLobbyBtn'),
            backToGamesBtnSoiHu: document.getElementById('backToGamesBtn'),
            videoBackgroundSoiHu: document.getElementById('video-background-soihu'),
            appTitleSoiHu: document.getElementById('app-title'),
            dashboardContentSoiHu: document.getElementById('dashboardContent'),
            planButtonSoiHu: document.getElementById('plan-button'),
            planOutputSoiHu: document.getElementById('plan-output'),
            clickSoundSoiHu: document.getElementById('clickSound'),
            enterSoundSoiHu: document.getElementById('enterSound'),
            hoverSoundSoiHu: document.getElementById('hoverSound'),
            ambientSoundSoiHu: document.getElementById('ambientSound'),
            mainTitleSoiHu: document.getElementById('main-title'),
            goldenTimeBtn: document.getElementById('golden-time-btn'),
            planInputSoiHu: document.getElementById('plan-input'),
            tickerContentSoiHu: document.getElementById('ticker-content'),
            exitSoiHuBtn: document.getElementById('exitSoiHuBtn'),
            
            // Re-used Canvas for both Matrix effects
            matrixCanvas: document.getElementById('matrixCanvas'),
            
            // New modal and form for change password
            changePasswordModal: document.getElementById('change-password-modal'),
            reauthForm: document.getElementById('reauth-form'),
            reauthPasswordInput: document.getElementById('reauth-password'),
            changePasswordForm: document.getElementById('change-password-form'),
            currentPasswordInput: document.getElementById('current-password'),
            newPasswordInput: document.getElementById('new-password'),
        };

        // --- UI & UTILITY HELPERS ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        async function logActivity(message) {
            if (!auth.currentUser) return;
            try {
                const logCollectionRef = collection(db, 'users', auth.currentUser.uid, 'activityLog');
                await addDoc(logCollectionRef, { message, timestamp: serverTimestamp() });
            } catch (error) { console.error("Error logging activity:", error); }
        }

        const decodeText = (element) => {
            const originalText = element.dataset.text;
            if (!originalText) { return; }
            if (element.classList.contains('title-vip')) {
                element.textContent = originalText;
                return;
            }
            const chars = '!<>-_\\/[]{}‚Äî=+*^?#_';
            let frame = 0;
            const interval = setInterval(() => {
                element.textContent = originalText.split('').map((char, index) => {
                    if (index < frame) return originalText[index];
                    return chars[Math.floor(Math.random() * chars.length)];
                }).join('');
                if (frame >= originalText.length) clearInterval(interval);
                frame++;
            }, 50);
        };

        function animateCountUp(el, end, decimals = 0, suffix = '') {
            const duration = 1500;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                el.textContent = (progress * end).toFixed(decimals) + suffix;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
        
        // --- MEDIA & SOUND ENGINE ---
        function initializeMedia() {
            window.onYouTubeIframeAPIReady = () => {
                isYtReady = true;
                ytPlayer = new YT.Player('youtube-player', {
                    height: '360', width: '640', videoId: '16GcpkR3rMM',
                    playerVars: { 'autoplay': 1, 'controls': 0, 'loop': 1, 'playlist': '16GcpkR3rMM' },
                    events: { 'onReady': onPlayerReady }
                });
            };
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.head.appendChild(tag);

            // initializeSounds(); // moved to lazy init on first gesture
}

        function onPlayerReady(event) {
            event.target.setVolume(50);
            event.target.mute();
            event.target.playVideo();
        }

        function initializeSounds() {
            sound.click = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 } }).toDestination();
            sound.navigate = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.1 } }).toDestination();
            sound.confirm = new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.05 }, harmonicity: 3.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination();
            sound.error = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
            sound.open = new Tone.PluckSynth({ attackNoise: 1, dampening: 4000, resonance: 0.7 }).toDestination();
            sound.success = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
            sound.boot = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.5, decay: 0.5, sustain: 0.2, release: 1 } }).toDestination();
            sound.lb4_predict = new Tone.MembraneSynth().toDestination();
            sound.lb4_lowEnergy = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.05, decay: 0.1, sustain: 0 } }).toDestination();
            sound.chatMessage = new Tone.Synth({ oscillator: { type: 'sine' }, volume: -10, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.1 } }).toDestination();
        }
        
        function playSound(type, note = 'C4', duration = '8n') {
            if (!soundsReady || !sound[type]) return;
            try {
                if (type === 'soiHuScan') sound[type].triggerAttack();
                else sound[type].triggerAttackRelease(note, duration);
            } catch (e) { console.error("Sound play error:", e); }
        }
        
        function stopSound(type) {
            if (!soundsReady || !sound[type] || !sound[type].triggerRelease) return;
            try {
                sound[type].triggerRelease();
            } catch(e) { /* ignore */ }
        }

        const startMedia = async () => {
            if (soundsReady) {
                 if (isYtReady && ytPlayer && ytPlayer.isMuted()) {
                    // ytPlayer.unMute(); // ƒê√É T·∫ÆT √ÇM THANH N·ªÄN
                }
                return;
            }
            await Tone.start();
            soundsReady = true;
            console.log("Audio Context started.");
             if (isYtReady && ytPlayer && ytPlayer.isMuted()) {
                // ytPlayer.unMute(); // ƒê√É T·∫ÆT √ÇM THANH N·ªÄN
                console.log("YouTube player will remain muted.");
            }
        };

        // --- BACKGROUND EFFECTS ---
        function setupMatrixRain() {
            const canvas = DOMElements.matrixCanvas;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let w, h, cols, ypos = [];
            const characters = '„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„É∞„ÇÆ„Ç∏„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„É±„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éù„É¥„ÉÉ„É≥ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const fontSize = 16;
            let drops = [];
            const mouse = { x: undefined, y: undefined, radius: 100 };
            const ripples = [];

            function resizeCanvas() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
                cols = Math.ceil(w / fontSize);
                drops = [];
                for (let x = 0; x < cols; x++) drops[x] = 1;
            }

            function drawMatrix() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, w, h);
                ctx.font = fontSize + 'px monospace';

                for (let i = 0; i < drops.length; i++) {
                    const text = characters.charAt(Math.floor(Math.random() * characters.length));
                    const xPos = i * fontSize;
                    const yPos = drops[i] * fontSize;

                    const dxMouse = mouse.x - xPos;
                    const dyMouse = mouse.y - yPos;
                    const distMouse = Math.sqrt(dxMouse * dxMouse + dyMouse * dyMouse);
                    
                    let inRipple = false;
                    ripples.forEach(ripple => {
                        const dxRipple = ripple.x - xPos;
                        const dyRipple = ripple.y - yPos;
                        const distRipple = Math.sqrt(dxRipple * dxRipple + dyRipple * dyRipple);
                        if (distRipple < ripple.radius && distRipple > ripple.radius - 20) {
                            inRipple = true;
                        }
                    });

                    if (inRipple) {
                        ctx.fillStyle = '#ffb300';
                    } else if (distMouse < mouse.radius) {
                        ctx.fillStyle = `rgba(255, 255, 255, ${1 - distMouse / mouse.radius})`;
                    } else {
                        ctx.fillStyle = '#00FFFF';
                    }
                    
                    ctx.fillText(text, xPos, yPos);

                    if (yPos > h && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
                
                for (let i = ripples.length - 1; i >= 0; i--) {
                    const r = ripples[i];
                    r.radius += r.speed;
                    if (r.radius > r.maxRadius) {
                        ripples.splice(i, 1);
                    }
                }
            }

            window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
            window.addEventListener('click', e => { ripples.push({ x: e.x, y: e.y, radius: 0, maxRadius: 150, speed: 5 }); });
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            setInterval(drawMatrix, 33);
        }

        // --- AUTH LOGIC ---
        function getFirebaseErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'SAI T√äN/M·∫¨T KH·∫®U';
                case 'auth/user-disabled': return 'T√ÄI KHO·∫¢N B·ªä KH√ìA';
                case 'auth/email-already-in-use': return 'T√ÄI KHO·∫¢N ƒê√É T·ªíN T·∫†I';
                case 'auth/weak-password': return 'M·∫¨T KH·∫®U QU√Å Y·∫æU';
                case 'auth/requires-recent-login': return 'ƒê·ªÇ ƒê·ªîI M·∫¨T KH·∫®U, B·∫†N C·∫¶N ƒêƒÇNG NH·∫¨P L·∫†I.';
                default: return 'L·ªñI H·ªÜ TH·ªêNG KH√îNG X√ÅC ƒê·ªäNH';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            playSound('click');
            const username = DOMElements.loginUsernameInput.value.trim().toLowerCase();
            const password = DOMElements.loginPasswordInput.value;
            DOMElements.loginBtn.disabled = true;
            try {
                const fakeEmail = `${username}${CONFIG.authDomainSuffix}`;
                await signInWithEmailAndPassword(auth, fakeEmail, password);
                await logActivity("ƒêƒÉng nh·∫≠p v√†o h·ªá th·ªëng.");
                showNotification("K·∫øt n·ªëi th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...", "success");
            } catch (error) {
                showNotification(getFirebaseErrorMessage(error.code), "error");
            } finally {
                DOMElements.loginBtn.disabled = false;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            playSound('click');
            const username = document.getElementById('register-username').value.trim().toLowerCase();
            const phone = document.getElementById('register-phone').value.trim();
            const password = document.getElementById('register-password').value;
            const registerBtn = document.getElementById('registerBtn');
            if (!username || !phone || !password) {
                showNotification("Y√äU C·∫¶U ƒê·ª¶ TH√îNG TIN", "error");
                return;
            }
            registerBtn.disabled = true;
            try {
                const fakeEmail = `${username}${CONFIG.authDomainSuffix}`;
                // *** FIX: Assign the result of createUserWithEmailAndPassword to a constant ***
                const userCredential = await createUserWithEmailAndPassword(auth, fakeEmail, password);
                const userDocRef = doc(db, "users", userCredential.user.uid);
                await setDoc(userDocRef, { 
                    uid: userCredential.user.uid, 
                    username: username, 
                    phoneNumber: phone, 
                    energy: CONFIG.energy.initial,
                    // C·∫•p b·∫≠c m·∫∑c ƒë·ªãnh khi ƒëƒÉng k√Ω l√† th∆∞·ªùng
                    level: 'normal',
                    createdAt: serverTimestamp(),
                    avatarUrl: '',
                    f168Username: '',
                    f168UsernameLastChanged: null,
                    f168UsernameChangeCount: 0
                });
                await logActivity("T·∫°o t√†i kho·∫£n th√†nh c√¥ng.");
                showNotification("T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c t·∫°o! Vui l√≤ng ƒëƒÉng nh·∫≠p.", "success");
                DOMElements.registerForm.classList.add('hidden');
                DOMElements.loginForm.classList.remove('hidden');
                decodeText(DOMElements.loginForm.querySelector('h2'));
            } catch (error) {
                showNotification(getFirebaseErrorMessage(error.code), "error");
            } finally {
                registerBtn.disabled = false;
            }
        }

        // --- MAIN APP LOGIC ---
        let currentCoreIndex = 0;

        function updateUIWithUserData(userData) {
            const energy = userData.energy || 0;
            DOMElements.userPilotSpan.textContent = `PILOT: ${userData.username.toUpperCase()}`;
            // T·∫°o hi·ªáu ·ª©ng ƒë·∫≠m cho t√™n phi c√¥ng (m√†u s·∫Øc s·∫Ω c·∫≠p nh·∫≠t theo c·∫•p b·∫≠c b√™n d∆∞·ªõi)
            DOMElements.userPilotSpan.style.fontWeight = '700';
            // C·∫≠p nh·∫≠t c·∫•p b·∫≠c (th∆∞·ªùng/vip/premium) v√† m√†u s·∫Øc t∆∞∆°ng ·ª©ng
            const level = userData.level || 'normal';
            let levelColor;
            switch (level) {
                case 'vip':
                    levelColor = '#FFD700';
                    break;
                case 'v-vip':
                    levelColor = '#FF4500';
                    break;
                    levelColor = '#FFD700';
                    break;
                case 'premium':
                    levelColor = '#ff00ff';
                    break;
                case 'omega':
                    levelColor = '#00FF00';
                    break;
                default:
                    levelColor = '#00ffff';
                    break;
            }
            const levelLabel = level === 'normal' ? 'TH∆Ø·ªúNG' : level.toUpperCase();
            if (DOMElements.userLevelSpan) {
                DOMElements.userLevelSpan.textContent = levelLabel;
                DOMElements.userLevelSpan.style.color = levelColor;
                // Hi·ªáu ·ª©ng khung c·∫•p b·∫≠c v·ªõi vi·ªÅn v√† √°nh s√°ng neon
                DOMElements.userLevelSpan.style.padding = '2px 6px';
                DOMElements.userLevelSpan.style.border = `1px solid ${levelColor}`;
                DOMElements.userLevelSpan.style.borderRadius = '4px';
                DOMElements.userLevelSpan.style.boxShadow = `0 0 8px ${levelColor}`;
                DOMElements.userLevelSpan.style.fontWeight = '700';
                DOMElements.userLevelSpan.style.textShadow = `0 0 5px ${levelColor}, 0 0 15px ${levelColor}`;
            }
            // C·∫≠p nh·∫≠t m√†u s·∫Øc t√™n phi c√¥ng theo c·∫•p b·∫≠c ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi huy hi·ªáu
            if (DOMElements.userPilotSpan) {
                DOMElements.userPilotSpan.style.color = levelColor;
                DOMElements.userPilotSpan.style.textShadow = `0 0 5px ${levelColor}, 0 0 15px ${levelColor}`;
            }
            DOMElements.userEnergySpan.textContent = `ENERGY: ${energy}`;
            const avatarUrl = userData.avatarUrl || `https://placehold.co/50x50/0A192F/00ffff?text=${userData.username.charAt(0).toUpperCase()}`;
            DOMElements.userAvatarImg.src = avatarUrl;
            DOMElements.userAvatarImg.onerror = () => { DOMElements.userAvatarImg.src = `https://placehold.co/50x50/0A192F/00ffff?text=${userData.username.charAt(0).toUpperCase()}`; };
            DOMElements.userEnergySpan.classList.toggle('high', energy > 70);
            DOMElements.userEnergySpan.classList.toggle('low', energy < 30);
            DOMElements.userInfoBar.classList.toggle('low-energy', energy < 30);
            
            if (!DOMElements.longbaoIVScreen.classList.contains('hidden')) updateEnergyBarLB4();
            // Soi H·ªß screen does not have a dedicated energy bar to update

            const isEnergyLow = energy < 30;
            if (isEnergyLow && !wasEnergyLow) {
                DOMElements.lowEnergyModal.classList.remove('hidden');
                playSound('error');
            }
            wasEnergyLow = isEnergyLow;
            // Update dynamic menu each time user data is updated
            updateUserMenu(level);
        }

        /**
         * Build and display the user menu based on account level.
         * Levels hierarchy: normal < vip < v-vip < premium < omega.
         * The menu is highlighted for VIP level and above.
         */
        function updateUserMenu(level) {
            const menuEl = document.getElementById('user-menu');
            if (!menuEl) return;
            // Define the level hierarchies
            const vipLevels = ['vip','v-vip','premium','omega'];
            const vvipLevels = ['v-vip','premium','omega'];
            const premiumLevels = ['premium','omega'];
            // Determine which items should be included based on level
            const items = [];
            if (vipLevels.includes(level)) {
                items.push({ label: 'B·∫£o v·ªá t√†i kho·∫£n', handler: startAccountProtection });
            }
            if (vvipLevels.includes(level)) {
                items.push({ label: '·ª®ng ti·ªÅn', handler: () => { alert('Ch·ª©c nƒÉng ·ª®ng ti·ªÅn ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.'); } });
            }
            if (premiumLevels.includes(level)) {
                items.push({ label: 'G·ªçi ƒë√†o vui v·∫ª', handler: () => { alert('Ch·ª©c nƒÉng G·ªçi ƒë√†o vui v·∫ª ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.'); } });
            }
            if (level === 'omega') {
                items.push({ label: 'Ho√†n ti·ªÅn', handler: () => { alert('Ch·ª©c nƒÉng Ho√†n ti·ªÅn ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.'); } });
            }
            // If no items available, hide the entire menu
            if (items.length === 0) {
                menuEl.classList.add('hidden');
                return;
            } else {
                menuEl.classList.remove('hidden');
            }
            // Get or create the toggle button and items container
            let toggleBtn = document.getElementById('user-menu-toggle');
            let itemsContainer = document.getElementById('user-menu-items');
            if (!toggleBtn) {
                toggleBtn = document.createElement('button');
                toggleBtn.id = 'user-menu-toggle';
                toggleBtn.textContent = 'Menu';
                toggleBtn.addEventListener('click', () => {
                    if (itemsContainer) itemsContainer.classList.toggle('show');
                });
                menuEl.appendChild(toggleBtn);
            }
            if (!itemsContainer) {
                itemsContainer = document.createElement('div');
                itemsContainer.id = 'user-menu-items';
                menuEl.appendChild(itemsContainer);
            }
            // Highlight the toggle when VIP level or above
            if (vipLevels.includes(level)) {
                menuEl.classList.add('vip-highlight');
                toggleBtn.textContent = 'Menu VIP';
            } else {
                menuEl.classList.remove('vip-highlight');
                toggleBtn.textContent = 'Menu';
            }
            // Build the menu items
            itemsContainer.innerHTML = '';
            items.forEach(({ label, handler }) => {
                const btn = document.createElement('button');
                btn.textContent = label;
                btn.addEventListener('click', () => {
                    // Hide the dropdown when an item is clicked
                    itemsContainer.classList.remove('show');
                    handler();
                });
                itemsContainer.appendChild(btn);
            });
        }

        /**
         * Display a hacker-style progress modal for the account protection feature.
         * Messages will appear one by one to simulate scanning and securing the account.
         */
        function startAccountProtection() {
            const modal = document.getElementById('account-protection-modal');
            const content = document.getElementById('account-protection-content');
            if (!modal || !content) return;
            // Prepare modal
            content.innerHTML = '';
            modal.classList.add('show');
            // Sequence of messages for the hacker effect
            const messages = [
                'ƒêANG KI·ªÇM TRA T√ÄI KHO·∫¢N...',
                'ƒêANG KI·ªÇM TRA NHI·ªÄU IP',
                'ƒêANG THAY ƒê·ªîI IP HI·ªÜN T·∫†I',
                'ƒêANG XO√Å D·∫§U V·∫æT TR√äN TRANG ...',
                'ƒêANG L√ÄM S·∫†CH T√ÄI KHO·∫¢N',
                'ƒêANG K·∫æT N·ªêI L·∫†I V·ªöI TOOL...',
                'HO√ÄN T·∫§T ! H√ÉY V√î GAME'
            ];
            let index = 0;
            /**
             * Types out text one character at a time on the given line element. Once finished, calls the callback.
             * @param {string} text The message to type
             * @param {HTMLElement} element The DOM element to populate
             * @param {function} callback Invoked after the message has finished typing
             */
            function typeWriter(text, element, callback) {
                let i = 0;
                // Add a span to act as a blinking cursor
                const cursor = document.createElement('span');
                cursor.classList.add('hacker-cursor');
                element.appendChild(cursor);
                function type() {
                    if (i < text.length) {
                        element.insertBefore(document.createTextNode(text.charAt(i)), cursor);
                        i++;
                        setTimeout(type, 75);
                    } else {
                        // remove cursor after finishing typing
                        cursor.remove();
                        if (callback) callback();
                    }
                }
                type();
            }

            function showNext() {
                if (index < messages.length) {
                    const line = document.createElement('div');
                    line.className = 'hacker-text';
                    content.appendChild(line);
                    const msg = messages[index];
                    index++;
                    // type out message then show next after short pause
                    typeWriter(msg, line, () => {
                        setTimeout(showNext, 250);
                    });
                } else {
                    // Auto hide modal after a short delay once all messages have finished
                    setTimeout(() => {
                        modal.classList.remove('show');
                        content.innerHTML = '';
                    }, 1800);
                }
            }
            showNext();
        }

        function renderAICores() {
            DOMElements.coreOptionsContainer.innerHTML = '';
            CONFIG.ai_cores.forEach((core, index) => {
                const coreEl = document.createElement('div');
                coreEl.className = 'core-card';
                if (core.id === 'aquarius') {
                    coreEl.classList.add('vip');
                }
                coreEl.innerHTML = `
                    <h3>${core.name}</h3>
                    <div class="gif-container"><iframe src="${core.gif}" frameBorder="0" class="giphy-embed" allowFullScreen></iframe></div>
                    <p class="core-description">${core.description}</p>
                `;
                coreEl.dataset.index = index;
                
                coreEl.addEventListener('click', (e) => {
                    const clickedIndex = parseInt(e.currentTarget.dataset.index);
                    if (clickedIndex === currentCoreIndex) {
                        playSound('confirm');
                        const selectedCore = CONFIG.ai_cores[currentCoreIndex];
                        showCoreLoadingAnimation(selectedCore.id);
                    } else {
                        currentCoreIndex = clickedIndex;
                        updateCoreDisplay();
                    }
                });
                DOMElements.coreOptionsContainer.appendChild(coreEl);
            });
            updateCoreDisplay();

            document.querySelectorAll('.core-card').forEach(card => {
                const centerOfScreen = window.innerWidth / 2;
                const cardX = card.getBoundingClientRect().left + (card.offsetWidth / 2);
                card.style.setProperty('--card-x', cardX);
                card.style.setProperty('--center-x', centerOfScreen);
            });
        }

        function updateCoreDisplay() {
            const cards = document.querySelectorAll('.core-card');
            cards.forEach((card, index) => {
                card.classList.remove('active', 'prev', 'next', 'inactive');
                card.style.transform = '';
                let distance = index - currentCoreIndex;

                if (distance === 0) {
                    card.classList.add('active');
                } else if (distance === -1 || distance === CONFIG.ai_cores.length - 1) {
                    card.classList.add('prev');
                } else if (distance === 1 || distance === -(CONFIG.ai_cores.length - 1)) {
                    card.classList.add('next');
                } else {
                    card.classList.add('inactive');
                }
            });
        }

        function handleCoreNavigation(direction) {
            playSound('navigate', direction === 1 ? 'E4' : 'C4');
            currentCoreIndex = (currentCoreIndex + direction + CONFIG.ai_cores.length) % CONFIG.ai_cores.length;
            updateCoreDisplay();
        }
        
        function handleActivateCore(coreId) {
            switch (coreId) {
                case 'longbao_iv':
                    launchLongBaoIV();
                    break;
                case 'soi_hu':
                    launchSoiHu();
                    break;
                case 'yian':
                    if (currentUserData && currentUserData.energy >= 5) {
                        // T√≠nh to√°n nƒÉng l∆∞·ª£ng m·ªõi v√† c·∫≠p nh·∫≠t d·ªØ li·ªáu c·ª•c b·ªô
                        const newEnergy = currentUserData.energy - 5;
                        currentUserData.energy = newEnergy;
                        // Ghi nƒÉng l∆∞·ª£ng m·ªõi l√™n Firestore
                        const userDocRef = doc(db, "users", auth.currentUser.uid);
                        updateDoc(userDocRef, { energy: newEnergy });
                        logActivity(`K√≠ch ho·∫°t L√µi Yian (-5 nƒÉng l∆∞·ª£ng).`);
                        // X√¢y d·ª±ng URL k√®m tham s·ªë t√™n ng∆∞·ªùi d√πng v√† nƒÉng l∆∞·ª£ng ƒë·ªÉ truy·ªÅn sang Yian
                        const baseUrl = CONFIG.ai_cores.find(c => c.id === 'yian').externalUrl;
                        const url = `${baseUrl}?username=${encodeURIComponent(currentUserData.username)}&energy=${encodeURIComponent(newEnergy)}`;
                        // Hi·ªÉn th·ªã l√µi Yian trong overlay thay v√¨ m·ªü c·ª≠a s·ªï m·ªõi
                        const yianOverlay = document.getElementById('yian-overlay');
                        const yianFrame = document.getElementById('yian-frame');
                        if (yianFrame) {
                            yianFrame.src = url;
                        }
                        if (yianOverlay) {
                            yianOverlay.style.display = 'block';
                        }
                    } else {
                        showNotification(`Kh√¥ng ƒë·ªß nƒÉng l∆∞·ª£ng! C·∫ßn 5 nƒÉng l∆∞·ª£ng.`, "error");
                    }
                    break;
                case 'aquarius':
                    window.open(CONFIG.ai_cores.find(c => c.id === 'aquarius').externalUrl, '_blank');
                    break;
            }
        }

        function showCoreLoadingAnimation(coreId) {
            const modal = DOMElements.coreLoadingModal;
            const bar = DOMElements.loadingProgressBar;
            const text = DOMElements.loadingPercentage;
            
            modal.classList.remove('hidden');
            let percentage = 0;
            
            const interval = setInterval(() => {
                percentage++;
                bar.style.width = `${percentage}%`;
                text.textContent = `${percentage}%`;
                
                if (percentage >= 100) {
                    clearInterval(interval);
                    DOMElements.loadingStatusText.textContent = "N·∫†P L√ïI TH√ÄNH C√îNG!";
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        handleActivateCore(coreId);
                        setTimeout(() => {
                           bar.style.width = '0%';
                           text.textContent = '0%';
                           DOMElements.loadingStatusText.textContent = "ƒêANG N·∫†P L√ïI...";
                        }, 500);
                    }, 1000);
                }
            }, 30);
        }

        // --- CHATBOT LOGIC (GEMINI INTEGRATED) ---
        function initChatbot() {
            // N·∫øu currentUserData ch∆∞a ƒë∆∞·ª£c g√°n (ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p), s·ª≠ d·ª•ng t√™n m·∫∑c ƒë·ªãnh ƒë·ªÉ tr√°nh l·ªói null
            const username = (currentUserData && currentUserData.username) ? currentUserData.username : 'Ng∆∞·ªùi d√πng';
            chatHistory = [
                {
                    role: "user",
                    parts: [{ text: `System instruction: You are A.I Long B·∫£o Th·∫ø H·ªá IV, an expert assistant for a gaming analysis tool. Your user is named ${username}. Your purpose is to be a helpful and friendly companion. Keep your answers concise, helpful, and in Vietnamese.
                    You have a specific knowledge base. Answer questions based ONLY on this information.
                    
                    **V·ªÅ D·ª± √Ån v√† ƒêƒÉng K√Ω:**
                    - **Ng∆∞·ªùi t·∫°o ra tool:** Tool n√†y ƒë∆∞·ª£c t·∫°o ra b·ªüi Long B·∫£o.
                    - **Link ƒëƒÉng k√Ω:** ƒê·ªÉ ƒëƒÉng k√Ω t√†i kho·∫£n, h√£y truy c·∫≠p www.f168.codes. Ch·ªâ c√°c t√†i kho·∫£n ƒëƒÉng k√Ω qua link n√†y m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng tool.
                    - **M·ª•c ƒë√≠ch c·ªßa tool:** ƒê√¢y l√† c√¥ng c·ª• A.I gi√∫p ph√¢n t√≠ch game v√† tƒÉng t·ªâ l·ªá th·∫Øng cho ng∆∞·ªùi ch∆°i.
                    - **C√°ch ho·∫°t ƒë·ªông:** Tool s·ª≠ d·ª•ng c√¥ng ngh·ªá A.I ti√™n ti·∫øn v√† s·ª©c m·∫°nh c·ªßa GPU ƒë·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu game, t·ª´ ƒë√≥ ƒë∆∞a ra nh·ªØng d·ª± ƒëo√°n c√≥ ƒë·ªô ch√≠nh x√°c cao.
                    
                    **V·ªÅ NƒÉng L∆∞·ª£ng:**
                    - **NƒÉng l∆∞·ª£ng l√† g√¨:** NƒÉng l∆∞·ª£ng l√† ƒë∆°n v·ªã ƒë·ªÉ s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng c·ªßa tool. M·ªói h√†nh ƒë·ªông nh∆∞ chat v·ªõi A.I ho·∫∑c k√≠ch ho·∫°t l√µi s·∫Ω ti√™u t·ªën m·ªôt l∆∞·ª£ng nƒÉng l∆∞·ª£ng nh·∫•t ƒë·ªãnh.
                    - **L√†m sao ƒë·ªÉ c√≥ th√™m nƒÉng l∆∞·ª£ng:** Khi h·∫øt nƒÉng l∆∞·ª£ng, b·∫°n c·∫ßn li√™n h·ªá Long B·∫£o qua Telegram ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ n·∫°p th√™m.
                    - **Chi ph√≠ chat:** M·ªói c√¢u h·ªèi b·∫°n h·ªèi t√¥i s·∫Ω t·ªën ${CONFIG.energy.costs.geminiChat} nƒÉng l∆∞·ª£ng.
                    
                    **V·ªÅ C√°c L√µi A.I:**
                    - **L√µi LongBao IV:** D√πng ƒë·ªÉ d·ª± ƒëo√°n k·∫øt qu·∫£ Baccarat (Nh√† Con/Nh√† C√°i) v√† ƒë∆∞a ra l√Ω do ph√¢n t√≠ch.
                    - **L√µi Soi H≈©:** Ch·ª©c nƒÉng n√†y hi·ªán ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn v√† s·∫Ω s·ªõm ra m·∫Øt.
                    - **L√µi Aquarius:** ƒê√¢y l√† si√™u l√µi m·∫°nh nh·∫•t v·ªõi t·ªâ l·ªá th·∫Øng 99%, y√™u c·∫ßu m√£ k√≠ch ho·∫°t ri√™ng.
                    
                    **V·ªÅ B·∫£n Th√¢n:**
                    - **B·∫°n l√† ai:** T√¥i l√† A.I Long B·∫£o, tr·ª£ l√Ω ·∫£o c·ªßa b·∫°n.
                    - **N·ªÅn t·∫£ng:** T√¥i ƒë∆∞·ª£c ph√°t tri·ªÉn d·ª±a tr√™n m√¥ h√¨nh Gemini c·ªßa Google v√† ƒë∆∞·ª£c hu·∫•n luy·ªán b·ªüi Long B·∫£o.

                    This was your system instruction. Now, begin the conversation by greeting the user.`}]
                },
                {
                    role: "model",
                    parts: [{ text: `K·∫øt n·ªëi th√†nh c√¥ng! T√¥i l√† A.I Long B·∫£o, ng∆∞·ªùi ƒë·ªìng h√†nh c·ªßa b·∫°n. B·∫°n c·∫ßn h·ªó tr·ª£ g√¨?` }]
                }
            ];
            DOMElements.chatMessages.innerHTML = '';
            renderChatMessage({
                username: 'A.I LongBao',
                text: chatHistory[1].parts[0].text,
                isAI: true
            });
        }
        
        function renderChatMessage(data) {
            const msgContainer = document.createElement('div');
            msgContainer.className = `chat-message ${data.isAI ? 'ai' : 'user'}`;
            if (data.id) {
                msgContainer.id = data.id;
            }

            msgContainer.innerHTML = `
                <span class="chat-username">${data.username}:</span>
                <span class="chat-text ${data.isAI ? 'ai' : 'user'}">${data.text}</span>
            `;
            DOMElements.chatMessages.appendChild(msgContainer);
            DOMElements.chatMessages.scrollTop = DOMElements.chatMessages.scrollHeight;
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const text = DOMElements.chatInput.value.trim();
            if (text === '' || !currentUserData) return;
            const gameInfoQuery = /t·ªâ l·ªá th·∫Øng c·ªßa game (.*) l√† bao nhi√™u?/i;
            const match = text.match(gameInfoQuery);
            if (match) {
                const gameName = match[1].trim().toLowerCase();
                let foundGame = null;
                for (const lobbyId in CONFIG.soiHuGames.allGames) {
                    foundGame = CONFIG.soiHuGames.allGames[lobbyId].find(game => game.name.toLowerCase() === gameName);
                    if (foundGame) break;
                }

                if (foundGame) {
                     renderChatMessage({ username: currentUserData.username, text, isAI: false });
                     const simulatedWinRate = (60 + Math.random() * 35).toFixed(2);
                     const reply = `Theo d·ªØ li·ªáu ph√¢n t√≠ch c·ªßa t√¥i, t·ª∑ l·ªá th·∫Øng c·ªßa game "${foundGame.name}" l√† kho·∫£ng ${simulatedWinRate}%. Ch√∫c b·∫°n may m·∫Øn!`;
                     renderChatMessage({ username: 'A.I LongBao', text: reply, isAI: true });
                     chatHistory.push({ role: "user", parts: [{ text }] }, { role: "model", parts: [{ text: reply }] });
                } else {
                     renderChatMessage({ username: currentUserData.username, text, isAI: false });
                     const reply = `T√¥i xin l·ªói, t√¥i kh√¥ng t√¨m th·∫•y th√¥ng tin v·ªÅ game "${gameName}" trong c∆° s·ªü d·ªØ li·ªáu.`;
                     renderChatMessage({ username: 'A.I LongBao', text: reply, isAI: true });
                     chatHistory.push({ role: "user", parts: [{ text }] }, { role: "model", parts: [{ text: reply }] });
                }
                DOMElements.chatInput.value = '';
                DOMElements.chatInput.disabled = false;
                return;
            }


            if (currentUserData.energy < CONFIG.energy.costs.geminiChat) {
                renderChatMessage({
                    username: 'A.I LongBao',
                    text: `Kh√¥ng ƒë·ªß nƒÉng l∆∞·ª£ng. B·∫°n c·∫ßn ${CONFIG.energy.costs.geminiChat} nƒÉng l∆∞·ª£ng ƒë·ªÉ h·ªèi, b·∫°n ƒëang c√≥ ${currentUserData.energy}.`,
                    isAI: true
                });
                playSound('error');
                return;
            }
            
            const newEnergy = currentUserData.energy - CONFIG.energy.costs.geminiChat;
            const userDocRef = doc(db, "users", auth.currentUser.uid);
            await updateDoc(userDocRef, { energy: newEnergy });
            logActivity(`Chat v·ªõi A.I (-${CONFIG.energy.costs.geminiChat} nƒÉng l∆∞·ª£ng).`);

            renderChatMessage({ username: currentUserData.username, text, isAI: false });
            chatHistory.push({ role: "user", parts: [{ text }] });
            DOMElements.chatInput.value = '';
            DOMElements.chatInput.disabled = true;
            
            const thinkingId = 'thinking-indicator';
            renderChatMessage({
                username: 'A.I LongBao',
                text: `<div class="thinking-indicator"><span></span><span></span><span></span></div>`,
                isAI: true,
                id: thinkingId
            });

            try {
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

                const result = await response.json();
                
                document.getElementById(thinkingId)?.remove();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const aiReply = result.candidates[0].content.parts[0].text;
                    renderChatMessage({ username: 'A.I LongBao', text: aiReply, isAI: true });
                    chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
                    playSound('chatMessage', 'G5');
                } else {
                    throw new Error("Invalid response structure from API.");
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                document.getElementById(thinkingId)?.remove();
                renderChatMessage({
                    username: 'A.I LongBao',
                    text: 'T√¥i g·∫∑p s·ª± c·ªë khi k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.',
                    isAI: true
                });
            } finally {
                 DOMElements.chatInput.disabled = false;
                 DOMElements.chatInput.focus();
            }
        }
        
        // --- DRAGGABLE CHAT ROBOT LOGIC ---
        function initDraggableRobot() {
            const robot = DOMElements.chatRobotContainer;
            let isDragging = false;
            let offsetX, offsetY;

            const move = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                let newX = clientX - offsetX;
                let newY = clientY - offsetY;

                const rect = robot.getBoundingClientRect();
                newX = Math.max(0, Math.min(newX, window.innerWidth - rect.width));
                newY = Math.max(0, Math.min(newY, window.innerHeight - rect.height));

                robot.style.left = `${newX}px`;
                robot.style.top = `${newY}px`;
                
                const chatWindow = DOMElements.chatWindowContainer;
                const chatRect = chatWindow.getBoundingClientRect();

                let chatTop = newY - chatRect.height - 10;
                let chatLeft = newX + (rect.width / 2) - (chatRect.width / 2);

                if (chatTop < 10) {
                    chatTop = newY + rect.height + 10;
                }
                chatLeft = Math.max(10, Math.min(chatLeft, window.innerWidth - chatRect.width - 10));

                chatWindow.style.top = `${chatTop}px`;
                chatWindow.style.left = `${chatLeft}px`;
            };

            const startDrag = (e) => {
                isDragging = true;
                robot.classList.add('dragging');
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = robot.getBoundingClientRect();
                offsetX = clientX - rect.left;
                offsetY = clientY - rect.top;
                
                robot.style.right = 'auto';
                robot.style.bottom = 'auto';
                robot.style.left = `${rect.left}px`;
                robot.style.top = `${rect.top}px`;

                document.addEventListener('mousemove', move);
                document.addEventListener('touchmove', move, { passive: false });
            };

            const stopDrag = () => {
                isDragging = false;
                robot.classList.remove('dragging');
                document.removeEventListener('mousemove', move);
                document.removeEventListener('touchmove', move);
            };
            
            robot.addEventListener('mousedown', startDrag);
            document.addEventListener('mouseup', stopDrag);
            robot.addEventListener('touchstart', startDrag);
            document.addEventListener('touchend', stopDrag);

            robot.addEventListener('click', (e) => {
                if(robot.classList.contains('dragging-check')) {
                     robot.classList.remove('dragging-check');
                     return;
                }
                DOMElements.robotSpeechBubble.classList.add('hidden');
                const chatWindow = DOMElements.chatWindowContainer;
                chatWindow.classList.toggle('hidden');

                if (!chatWindow.classList.contains('hidden')) {
                    const robotRect = robot.getBoundingClientRect();
                    const chatRect = chatWindow.getBoundingClientRect();
                    
                    let chatTop = robotRect.top - chatRect.height - 10;
                    let chatLeft = robotRect.left + (robotRect.width / 2) - (chatRect.width / 2);

                    if (chatTop < 10) {
                        chatTop = robotRect.bottom + 10;
                    }
                    chatLeft = Math.max(10, Math.min(chatLeft, window.innerWidth - chatRect.width - 10));

                    chatWindow.style.top = `${chatTop}px`;
                    chatWindow.style.left = `${chatLeft}px`;
                }
            });
            
            robot.addEventListener('mousemove', () => {
                if(isDragging) robot.classList.add('dragging-check');
            });
            robot.addEventListener('mousedown', () => {
                robot.classList.remove('dragging-check');
            });
        }


        // --- CORE: LONGB√ÉO IV LOGIC ---
        let allTablesState = {};
        let currentVisibleTable = null;
        let lb4ConfigData = null;
        let lb4AnimationId;
        let streakCheckInterval;

        async function launchLongBaoIV() {
            logActivity("Kh·ªüi ch·∫°y L√µi LongBao IV.");
            DOMElements.aiCoreSelectionScreen.classList.add('hidden');
            DOMElements.longbaoIVScreen.classList.remove('hidden');
            DOMElements.tableSelectionScreen.classList.remove('hidden');
            DOMElements.toolScreen.classList.add('hidden');

            if (!lb4ConfigData) {
                try {
                    const docRef = doc(db, "config", "longbao_iv");
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists() && docSnap.data().tables) {
                        lb4ConfigData = docSnap.data();
                    } else {
                        console.warn("Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh LongBao IV tr√™n Firestore. S·ª≠ d·ª•ng c·∫•u h√¨nh m·∫∑c ƒë·ªãnh.");
                        lb4ConfigData = DEFAULT_CONFIG.longbao_iv;
                    }
                } catch (error) {
                    console.error("L·ªói t·∫£i c·∫•u h√¨nh LongBao IV:", error, ". S·ª≠ d·ª•ng c·∫•u h√¨nh m·∫∑c ƒë·ªãnh.");
                    lb4ConfigData = DEFAULT_CONFIG.longbao_iv;
                }
            }
            
            initializeAllTablesState();
            generateTableListLB4();
            if (!globalUpdateInterval) startGlobalUpdater();
            if (!streakCheckInterval) streakCheckInterval = setInterval(checkForStreaks, 5000);
            
            initLongBaoIVBackground();
            updateSuggestedTableLB4();
            setInterval(updateSuggestedTableLB4, 10000);
        }
        
        function initializeAllTablesState() {
            const now = Date.now();
            if (!lb4ConfigData || !lb4ConfigData.tables) return;
            
            const outcomes = ['NH√Ä CON', 'NH√Ä C√ÅI'];

            for (const name of lb4ConfigData.tables) {
                const initialHistory = [];
                let wins = 0;
                let losses = 0;
                const initialRoundCount = Math.floor(Math.random() * 21) + 30;
                const winRateChance = (Math.floor(Math.random() * (95 - 70 + 1)) + 70) / 100;

                for (let i = 0; i < initialRoundCount; i++) {
                    const result = outcomes[Math.floor(Math.random() * outcomes.length)];
                    initialHistory.push(result);
                    const randomPrediction = outcomes[Math.floor(Math.random() * outcomes.length)];
                    if (randomPrediction === result) wins++; else losses++;
                }

                allTablesState[name] = {
                    name: name, 
                    round: initialRoundCount, 
                    wins: wins, 
                    losses: losses, 
                    history: initialHistory,
                    winRateChance: winRateChance,
                    lastPrediction: null,
                    nextUpdateTime: now + Math.random() * CONFIG.longbao_iv.prediction_interval
                };
            }
        }
        
        function runAdvancedPredictionLogic(tableName) {
            const tableState = allTablesState[tableName];
            const history = tableState.history;
            let playerChance = 0.5;
            let reasoning = "Ph√¢n t√≠ch d·ªØ li·ªáu ng·∫´u nhi√™n...";

            if (history.length >= 3) {
                const last3 = history.slice(-3);
                if (last3.every(r => r === 'NH√Ä CON')) {
                    playerChance += 0.2;
                    reasoning = "Ph√°t hi·ªán chu·ªói 3 Nh√† Con. Theo c·∫ßu.";
                }
                if (last3.every(r => r === 'NH√Ä C√ÅI')) {
                    playerChance -= 0.2;
                    reasoning = "Ph√°t hi·ªán chu·ªói 3 Nh√† C√°i. Theo c·∫ßu.";
                }
            }
            if (history.length >= 4) {
                 const last4 = history.slice(-4);
                 if(last4[0] === last4[2] && last4[1] === last4[3] && last4[0] !== last4[1]){
                     if(last4[3] === 'NH√Ä C√ÅI') {
                        playerChance += 0.15;
                        reasoning = "Ph√°t hi·ªán c·∫ßu xen k·∫Ω (1-1).";
                     } else {
                        playerChance -= 0.15;
                        reasoning = "Ph√°t hi·ªán c·∫ßu xen k·∫Ω (1-1).";
                     }
                 }
            }

            playerChance = Math.max(0.1, Math.min(0.9, playerChance));
            
            const mainPrediction = Math.random() < playerChance ? 'NH√Ä CON' : 'NH√Ä C√ÅI';
            const subPrediction = CONFIG.longbao_iv.sub_outcomes[Math.floor(Math.random() * CONFIG.longbao_iv.sub_outcomes.length)];
            const isWin = Math.random() < tableState.winRateChance;
            const actualResult = isWin ? mainPrediction : (mainPrediction === 'NH√Ä CON' ? 'NH√Ä C√ÅI' : 'NH√Ä CON');
            
            tableState.round++;
            if (isWin) tableState.wins++; else tableState.losses++;
            if (tableState.history.length > 150) tableState.history.shift();
            tableState.history.push(actualResult);
            tableState.lastPrediction = { main: mainPrediction, sub: subPrediction, result: actualResult, reasoning: reasoning };
            tableState.nextUpdateTime = Date.now() + CONFIG.longbao_iv.prediction_interval + (Math.random() * 2000 - 1000);
        }

        async function updateAllTables() {
            const now = Date.now();
            for (const tableName in allTablesState) {
                const tableState = allTablesState[tableName];
                if (now >= tableState.nextUpdateTime) {
                    runAdvancedPredictionLogic(tableName);
                    
                    if (tableName === currentVisibleTable) {
                        if (currentUserData && currentUserData.energy >= CONFIG.energy.costs.longBaoIV) {
                            const newEnergy = currentUserData.energy - CONFIG.energy.costs.longBaoIV;
                            const userDocRef = doc(db, "users", auth.currentUser.uid);
                            await updateDoc(userDocRef, { energy: newEnergy });
                            logActivity(`S·ª≠ d·ª•ng L√µi LongBao IV (-${CONFIG.energy.costs.longBaoIV} nƒÉng l∆∞·ª£ng) t·∫°i b√†n ${tableName}.`);
                            updateVisibleTableUI();
                        } else {
                            playSound('lb4_lowEnergy', "C2", "0.2n");
                            DOMElements.energyModalLB4.classList.remove('hidden');
                            currentVisibleTable = null; 
                        }
                    }
                }
            }
        }

        function startGlobalUpdater() {
            if (globalUpdateInterval) clearInterval(globalUpdateInterval);
            globalUpdateInterval = setInterval(updateAllTables, 1000);
        }

        function exitLongBaoIV() {
            currentVisibleTable = null;
            DOMElements.longbaoIVScreen.classList.add('hidden');
            DOMElements.aiCoreSelectionScreen.classList.remove('hidden');
            if (lb4AnimationId) cancelAnimationFrame(lb4AnimationId);
            if (globalUpdateInterval) {
                clearInterval(globalUpdateInterval);
                globalUpdateInterval = null;
            }
            if (streakCheckInterval) {
                clearInterval(streakCheckInterval);
                streakCheckInterval = null;
            }
        }

        function generateTableListLB4() {
            DOMElements.tableListContainer.innerHTML = '';
            if (!lb4ConfigData || !lb4ConfigData.tables) {
                DOMElements.tableListContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†n ch∆°i.</p>';
                return;
            }
            lb4ConfigData.tables.forEach((name, index) => {
                const tableState = allTablesState[name] || { round: 0, winRateChance: 0.8, history: [] };
                const tableElement = document.createElement('div');
                tableElement.className = 'table-item-ultimate p-4 flex flex-col justify-between';
                tableElement.style.animationDelay = `${index * 50}ms`;
                tableElement.dataset.tableName = name;

                const miniHistoryHTML = tableState.history.slice(-12).map(result => {
                    const dotClass = result === 'NH√Ä CON' ? 'player' : 'banker';
                    return `<div class="mini-dot ${dotClass}"></div>`;
                }).join('');

                tableElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="text-left">
                            <span class="font-bold text-lg tracking-wider text-white">${name}</span>
                            <div class="text-xs text-gray-400">V√≤ng: <span class="font-bold text-white">${tableState.round}</span></div>
                        </div>
                        <div class="text-center px-3 py-1 bg-black/30 rounded-md border border-slate-600">
                            <p class="text-xs text-gray-400">T·ª∑ l·ªá th·∫Øng</p>
                            <p class="font-bold text-xl win-rate-text-ultimate">${Math.round(tableState.winRateChance * 100)}%</p>
                        </div>
                    </div>
                    <div class="mini-history-chart">
                        ${miniHistoryHTML}
                    </div>
                `;
                tableElement.addEventListener('click', () => {
                    playSound('confirm');
                    startToolForTableLB4(name);
                });
                DOMElements.tableListContainer.appendChild(tableElement);
            });
        }
        
        function updateVisibleTableUI() {
            if (!currentVisibleTable) return;
            const tableState = allTablesState[currentVisibleTable];
            const { main, sub, result, reasoning } = tableState.lastPrediction;
            updatePredictionUILB4(main, sub, reasoning);
            updateBetOptionsUILB4(main, sub);
            updateStatsUILB4();
            addDotToHistoryLB4(result);
            updateFluctuatingWinRateLB4();
            updateEnergyBarLB4();
            resetCountdownLB4();
            updateBettingSuggestion();
        }

        function renderFullTableState(tableName) {
            const tableState = allTablesState[tableName];
            DOMElements.historyGrid.innerHTML = '';
            tableState.history.forEach(result => addDotToHistoryLB4(result, false));
            updateStatsUILB4(false);
            if (tableState.lastPrediction) {
                const { main, sub, reasoning } = tableState.lastPrediction;
                updatePredictionUILB4(main, sub, reasoning, false);
                updateBetOptionsUILB4(main, sub);
            } else {
                DOMElements.mainPredictionText.textContent = 'CH·ªú...';
                DOMElements.subPredictionText.textContent = '';
                DOMElements.aiReasoning.textContent = 'ƒêang ch·ªù phi√™n m·ªõi...';
                DOMElements.mainPredictionText.className = 'text-5xl sm:text-6xl font-bold text-gray-500';
                DOMElements.betOptionsGrid.querySelectorAll('.bet-option-box').forEach(opt => opt.classList.remove('active'));
            }
            updateFluctuatingWinRateLB4();
            updateEnergyBarLB4();
            const timeRemaining = tableState.nextUpdateTime - Date.now();
            const percentageRemaining = Math.max(0, timeRemaining / CONFIG.longbao_iv.prediction_interval);
            DOMElements.countdownBar.style.transition = 'none';
            DOMElements.countdownBar.style.width = `${percentageRemaining * 100}%`;
            void DOMElements.countdownBar.offsetWidth;
            DOMElements.countdownBar.style.transition = `width ${timeRemaining / 1000}s linear`;
            DOMElements.countdownBar.style.width = '0%';
            updateBettingSuggestion();
        }
        
        function startToolForTableLB4(tableName) {
            DOMElements.tableSelectionScreen.classList.add('hidden');
            DOMElements.toolScreen.classList.remove('hidden');
            DOMElements.toolTitle.textContent = `D·ª∞ ƒêO√ÅN - ${tableName}`;
            currentVisibleTable = tableName;
            renderFullTableState(tableName);
        }

        function showTableSelectionScreenLB4() {
            currentVisibleTable = null;
            DOMElements.toolScreen.classList.add('hidden');
            DOMElements.tableSelectionScreen.classList.remove('hidden');
            generateTableListLB4();
        }

        function updatePredictionUILB4(mainPrediction, subPrediction, reasoning, animate = true) {
            if (animate) {
                playSound('lb4_predict', "C2", "8n");
                const shockwave = document.createElement('div');
                shockwave.className = 'shockwave';
                DOMElements.shockwaveContainer.appendChild(shockwave);
                setTimeout(() => shockwave.remove(), 700);
            }
            const mainStyles = { 'NH√Ä CON': 'text-[var(--neon-blue)] glow-text-player', 'NH√Ä C√ÅI': 'text-[var(--neon-red)] glow-text-banker' };
            DOMElements.mainPredictionText.className = `text-5xl sm:text-6xl font-bold transition-all duration-300 ${mainStyles[mainPrediction] || ''}`;
            DOMElements.mainPredictionText.textContent = mainPrediction;
            DOMElements.subPredictionText.className = 'text-base sm:text-xl font-semibold mt-2 h-8 glow-text-gold';
            DOMElements.subPredictionText.textContent = `+ ${subPrediction}`;
            DOMElements.aiReasoning.textContent = `Ph√¢n T√≠ch A.I: ${reasoning}`;
        }

        function updateBetOptionsUILB4(mainPrediction, subPrediction) {
            DOMElements.betOptionsGrid.querySelectorAll('.bet-option-box').forEach(opt => opt.classList.remove('active'));
            const mainId = `bet-option-${mainPrediction.toLowerCase().replace(/ /g, '-')}`;
            document.getElementById(mainId)?.classList.add('active');
            const subId = `bet-option-${subPrediction.toLowerCase().replace(/ /g, '-')}`;
            document.getElementById(subId)?.classList.add('active');
        }

        function updateStatsUILB4(useAnimation = true) {
            if (!currentVisibleTable) return;
            const tableState = allTablesState[currentVisibleTable];
            if (useAnimation) {
                animateCountUp(DOMElements.roundCountEl, tableState.round);
                animateCountUp(DOMElements.totalWinsEl, tableState.wins);
                animateCountUp(DOMElements.totalLossesEl, tableState.losses);
            } else {
                DOMElements.roundCountEl.innerText = tableState.round;
                DOMElements.totalWinsEl.innerText = tableState.wins;
                DOMElements.totalLossesEl.innerText = tableState.losses;
            }
        }
        
        function updateFluctuatingWinRateLB4() {
            const fluctuatingRate = Math.floor(Math.random() * (90 - 80 + 1)) + 80;
            DOMElements.progressValue.textContent = `${fluctuatingRate}%`;
            DOMElements.progressCircle.style.setProperty('--progress', `${fluctuatingRate * 3.6}deg`);
        }
        
        function updateEnergyBarLB4() {
            if (!currentUserData) return;
            const energyPercent = Math.max(0, (currentUserData.energy / CONFIG.energy.max) * 100);
            DOMElements.energyBar.style.width = `${energyPercent}%`;
            DOMElements.energyTextLB4.textContent = `${Math.round(currentUserData.energy)} / ${CONFIG.energy.max}`;
            DOMElements.energyBar.classList.remove('energy-bar-pulsing');
            if (energyPercent > 60) DOMElements.energyBar.style.background = 'linear-gradient(90deg, var(--neon-green), var(--neon-blue))';
            else if (energyPercent > 30) DOMElements.energyBar.style.background = 'linear-gradient(90deg, #facc15, #fb923c)';
            else {
                DOMElements.energyBar.style.background = 'linear-gradient(90deg, #fb923c, #ef4444)';
                if (energyPercent > 0) DOMElements.energyBar.classList.add('energy-bar-pulsing');
            }
        }

        function addDotToHistoryLB4(result, animate = true) {
            const dot = document.createElement('div');
            const outcomeClasses = { 'NH√Ä CON': 'dot-player', 'NH√Ä C√ÅI': 'dot-banker', 'H√íA': 'dot-tie' };
            dot.className = `history-dot ${outcomeClasses[result]}`;
            if (!animate) dot.style.animation = 'none';
            DOMElements.historyGrid.appendChild(dot);
            if (DOMElements.historyGrid.children.length > 150) {
                DOMElements.historyGrid.removeChild(DOMElements.historyGrid.firstChild);
            }
        }

        function resetCountdownLB4() {
            DOMElements.countdownBar.style.transition = 'none';
            DOMElements.countdownBar.style.width = '100%';
            void DOMElements.countdownBar.offsetWidth;
            const interval = allTablesState[currentVisibleTable]?.nextUpdateTime - Date.now() || CONFIG.longbao_iv.prediction_interval;
            DOMElements.countdownBar.style.transition = `width ${interval / 1000}s linear`;
            DOMElements.countdownBar.style.width = '0%';
        }

        function updateSuggestedTableLB4() {
            if (!lb4ConfigData || !lb4ConfigData.tables || lb4ConfigData.tables.length === 0) return;
            
            let bestTable = '';
            let highestRate = 0;

            for (const tableName in allTablesState) {
                const tableState = allTablesState[tableName];
                if (tableState.winRateChance > highestRate) {
                    highestRate = tableState.winRateChance;
                    bestTable = tableName;
                }
            }

            if (bestTable === '') {
                bestTable = lb4ConfigData.tables[Math.floor(Math.random() * lb4ConfigData.tables.length)];
                highestRate = allTablesState[bestTable]?.winRateChance || (Math.random() * (0.9 - 0.8) + 0.8);
            }

            const winPercentage = (highestRate * 100).toFixed(0);
            DOMElements.suggestedTableNameEl.innerHTML = `${bestTable} <span style="color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green);">~${winPercentage}%</span>`;
        }

        function initLongBaoIVBackground() {
            const canvas = document.getElementById('longbaoIV-background-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            
            function setupCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                particles = [];
                const numParticles = Math.floor(canvas.width / 40);
                for (let i = 0; i < numParticles; i++) {
                    particles.push({
                        x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                        size: Math.random() * 1.5 + 1,
                        speedX: Math.random() * 1 - 0.5, speedY: Math.random() * 1 - 0.5,
                        color: 'rgba(0, 255, 155, 0.7)'
                    });
                }
            }

            function animate() {
                if(DOMElements.longbaoIVScreen.classList.contains('hidden')) {
                    cancelAnimationFrame(lb4AnimationId);
                    return;
                };
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.x += p.speedX; p.y += p.speedY;
                    if (p.x > canvas.width || p.x < 0) p.speedX *= -1;
                    if (p.y > canvas.height || p.y < 0) p.speedY *= -1;
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
                });
                for (let a = 0; a < particles.length; a++) {
                    for (let b = a; b < particles.length; b++) {
                        const distance = Math.sqrt((particles[a].x - particles[b].x) ** 2 + (particles[a].y - particles[b].y) ** 2);
                        if (distance < 100) {
                            ctx.strokeStyle = `rgba(0, 255, 155, ${1 - distance / 100})`;
                            ctx.lineWidth = 0.5;
                            ctx.beginPath(); ctx.moveTo(particles[a].x, particles[a].y); ctx.lineTo(particles[b].x, particles[b].y); ctx.stroke();
                        }
                    }
                }
                lb4AnimationId = requestAnimationFrame(animate);
            }
            
            setupCanvas();
            animate();
            window.addEventListener('resize', setupCanvas);
        }

        // --- ULTIMATE FEATURES ---

        function checkForStreaks() {
            const STREAK_LENGTH = 5;
            let changed = false;
            for (const tableName in allTablesState) {
                const tableState = allTablesState[tableName];
                const history = tableState.history;
                if (history.length < STREAK_LENGTH) continue;

                const lastFive = history.slice(-STREAK_LENGTH);
                const first = lastFive[0];
                const isStreak = lastFive.every(res => res === first);

                if (isStreak && !hotTables[tableName]) {
                    hotTables[tableName] = { type: 'streak', notified: false };
                    changed = true;
                } else if (!isStreak && hotTables[tableName]) {
                    delete hotTables[tableName];
                    changed = true;
                }
            }

            if (changed) {
                updateTableSelectionUI();
                for (const tableName in hotTables) {
                    if (!hotTables[tableName].notified) {
                        showNotification(`üî• B√†n ${tableName} ƒëang c√≥ c·∫ßu b·ªát!`, 'info');
                        hotTables[tableName].notified = true;
                    }
                }
            }
        }

        function updateTableSelectionUI() {
            if (DOMElements.tableSelectionScreen.classList.contains('hidden')) return;
            const tableElements = DOMElements.tableListContainer.querySelectorAll('.table-item-ultimate');
            tableElements.forEach(el => {
                const tableName = el.dataset.tableName;
                if (hotTables[tableName]) {
                    el.classList.add('hot-streak');
                } else {
                    el.classList.remove('hot-streak');
                }
            });
        }
        
        async function handleAdvancedAnalysis() {
            if (!currentVisibleTable) return;
            const cost = CONFIG.energy.costs.advancedAnalysis;
            if (!currentUserData || currentUserData.energy < cost) {
                playSound('error');
                showNotification(`Kh√¥ng ƒë·ªß nƒÉng l∆∞·ª£ng! C·∫ßn ${cost}, b·∫°n c√≤n ${currentUserData.energy}.`, "error");
                return;
            }

            const newEnergy = currentUserData.energy - cost;
            const userDocRef = doc(db, "users", auth.currentUser.uid);
            await updateDoc(userDocRef, { energy: newEnergy });
            logActivity(`S·ª≠ d·ª•ng Soi C·∫ßu N√¢ng Cao (-${cost} nƒÉng l∆∞·ª£ng) t·∫°i b√†n ${currentVisibleTable}.`);
            
            playSound('open');
            const analysis = calculateAdvancedAnalysis(currentVisibleTable);
            
            DOMElements.analysisModalTitle.textContent = `PH√ÇN T√çCH N√ÇNG CAO - ${currentVisibleTable}`;
            DOMElements.analysisStability.innerHTML = `<span style="color: ${analysis.stability.color}">${analysis.stability.text}</span>`;
            DOMElements.analysisPatterns.innerHTML = Object.entries(analysis.patterns).map(([key, value]) => `<li>${key}: ${value} l·∫ßn</li>`).join('');
            DOMElements.analysisNextPredictions.innerHTML = analysis.nextPredictions.map(p => `<li>${p.outcome} <span class="text-gray-400">(${p.chance}%)</span></li>`).join('');
            
            DOMElements.advancedAnalysisModal.classList.remove('hidden');
        }

        function calculateAdvancedAnalysis(tableName) {
            const history = allTablesState[tableName].history.slice(-50);
            let changes = 0;
            let patterns = { 'C·∫ßu B·ªát': 0, 'C·∫ßu 1-1': 0, 'C·∫ßu 2-2': 0, 'Kh√°c': 0 };
            
            for (let i = 1; i < history.length; i++) {
                if (history[i] !== history[i - 1]) changes++;
                if (i >= 1 && history[i] !== history[i-1] && history[i-1] !== history[i-2]) patterns['C·∫ßu 1-1']++;
                if (i >= 3 && history[i] === history[i-1] && history[i-2] === history[i-3] && history[i-1] !== history[i-2]) patterns['C·∫ßu 2-2']++;
                if (i >= 2 && history[i] === history[i-1] && history[i-1] === history[i-2]) patterns['C·∫ßu B·ªát']++;
            }

            const stabilityValue = 1 - (changes / history.length);
            let stability = {};
            if (stabilityValue > 0.7) stability = { text: 'R·∫•t ·ªîn ƒê·ªãnh', color: 'var(--success-green)' };
            else if (stabilityValue > 0.5) stability = { text: '·ªîn ƒê·ªãnh', color: 'var(--yellow)' };
            else stability = { text: 'Bi·∫øn ƒê·ªông', color: 'var(--error-red)' };

            const lastOutcome = history[history.length - 1];
            let nextPredictions = [
                { outcome: lastOutcome, chance: Math.round(stabilityValue * 100) },
                { outcome: lastOutcome === 'NH√Ä CON' ? 'NH√Ä C√ÅI' : 'NH√Ä CON', chance: Math.round((1 - stabilityValue) * 100) },
                { outcome: lastOutcome, chance: Math.round(stabilityValue * 70) }
            ];

            return { stability, patterns, nextPredictions };
        }

        function updateBettingSuggestion() {
            if (!currentVisibleTable || userCapital <= 0) {
                DOMElements.bettingSuggestion.textContent = '';
                return;
            }
            const tableState = allTablesState[currentVisibleTable];
            if (!tableState.lastPrediction) {
                DOMElements.bettingSuggestion.textContent = '';
                return;
            }

            const reasoning = tableState.lastPrediction.reasoning;
            let confidence = 0.5;
            if (reasoning.includes("chu·ªói 3")) confidence = 0.8;
            if (reasoning.includes("xen k·∫Ω")) confidence = 0.7;

            let suggestionText = '';
            if (confidence > 0.75) {
                suggestionText = `C∆∞·ª£c ${Math.round(userCapital * 0.05)}k (5%)`;
                DOMElements.bettingSuggestion.style.color = 'var(--success-green)';
            } else if (confidence > 0.6) {
                suggestionText = `C∆∞·ª£c ${Math.round(userCapital * 0.02)}k (2%)`;
                DOMElements.bettingSuggestion.style.color = 'var(--yellow)';
            } else {
                suggestionText = 'B·ªè qua / C∆∞·ª£c nh·ªè';
                DOMElements.bettingSuggestion.style.color = 'var(--error-red)';
            }
            DOMElements.bettingSuggestion.textContent = suggestionText;
        }

        // --- CORE: SOI H·ª¶ LOGIC ---
        
        function launchSoiHu() {
            logActivity("Kh·ªüi ch·∫°y L√µi SƒÉn H≈©.");
            DOMElements.aiCoreSelectionScreen.classList.add('hidden');
            DOMElements.soiHuScreen.classList.remove('hidden');
            DOMElements.videoBackgroundSoiHu.style.display = 'none';
            renderLobbySoiHu();
            startTickerSoiHu();
            typeEffectSoiHu(DOMElements.mainTitleSoiHu, 'CH·ªåN S·∫¢NH', 150);
            
            document.body.addEventListener('click', startAmbientSoundSoiHu, { once: true });
        }
        
        function exitSoiHu() {
            DOMElements.soiHuScreen.classList.add('hidden');
            DOMElements.aiCoreSelectionScreen.classList.remove('hidden');
            if (winRateInterval) clearInterval(winRateInterval);
        }

        function playSoundSoiHu(sound) {
            sound.currentTime = 0;
            sound.play().catch(e => {});
        }
        function startAmbientSoundSoiHu() {
            if (DOMElements.ambientSoundSoiHu.paused) {
                DOMElements.ambientSoundSoiHu.volume = 0.3;
                DOMElements.ambientSoundSoiHu.play().catch(e => {});
            }
        }

        function showScreenSoiHu(screenToShow) {
            [DOMElements.lobbyContainerSoiHu, DOMElements.appContainerSoiHu, DOMElements.analysisContainerSoiHu, DOMElements.scanContainerSoiHu].forEach(s => {
                if (s !== screenToShow) s.classList.add('hidden');
            });
            screenToShow.classList.remove('hidden');
        }

        function switchToLobbySoiHu() {
            playSoundSoiHu(DOMElements.clickSoundSoiHu);
            showScreenSoiHu(DOMElements.lobbyContainerSoiHu);
            DOMElements.videoBackgroundSoiHu.style.display = 'none';
            if (winRateInterval) clearInterval(winRateInterval);
            renderLobbySoiHu();
            typeEffectSoiHu(DOMElements.mainTitleSoiHu, 'CH·ªåN S·∫¢NH', 150);
        }

        async function switchToAppSoiHu(lobby) {
            playSoundSoiHu(DOMElements.enterSoundSoiHu);
            currentLobby = lobby;
            
            const cost = CONFIG.energy.costs.soiHuScan;
            if (!currentUserData || currentUserData.energy < cost) {
                 showNotification(`Kh√¥ng ƒë·ªß nƒÉng l∆∞·ª£ng! C·∫ßn ${cost} ƒë·ªÉ qu√©t, b·∫°n c√≤n ${currentUserData.energy}.`, "error");
                 return;
            }

            const newEnergy = currentUserData.energy - cost;
            const userDocRef = doc(db, "users", auth.currentUser.uid);
            await updateDoc(userDocRef, { energy: newEnergy });
            logActivity(`S·ª≠ d·ª•ng L√µi SƒÉn H·ªß (-${cost} nƒÉng l∆∞·ª£ng) t·∫°i s·∫£nh ${lobby.name}.`);

            showScreenSoiHu(DOMElements.appContainerSoiHu);
            DOMElements.videoBackgroundSoiHu.style.display = 'block';
            renderAppContentSoiHu(lobby);
        }

        function showAnalysisModalSoiHu(game) {
            playSoundSoiHu(DOMElements.enterSoundSoiHu);
            showScreenSoiHu(DOMElements.scanContainerSoiHu);
            setTimeout(() => {
                populateAnalysisDataSoiHu(game);
                showScreenSoiHu(DOMElements.analysisContainerSoiHu);
            }, 2500);
        }

        function backToGameGridSoiHu() {
            playSoundSoiHu(DOMElements.clickSoundSoiHu);
            showScreenSoiHu(DOMElements.appContainerSoiHu);
        }

        function renderLobbySoiHu() {
            DOMElements.lobbyGridSoiHu.innerHTML = CONFIG.soiHuGames.lobbyGameList.map(game => `
                <div class="lobby-card" data-lobby-id="${game.id}" data-lobby-name="${game.name}" data-tilt data-tilt-max="5" data-tilt-speed="400" data-tilt-perspective="500">
                    <div class="img-wrapper">
                        <img src="${game.imageUrl}" alt="Avatar s·∫£nh ${game.name}" onerror="this.onerror=null;this.src='https://placehold.co/150/1a1a1a/ffffff?text=X';" draggable="false" loading="lazy" decoding="async" fetchpriority="low">
                    </div>
                    <h2 class="lobby-card-name">${game.name}</h2>
                    <div class="lobby-card-stats">
                        <span id="stat-signal-${game.id}"></span> | <span id="stat-flow-${game.id}"></span>
                    </div>
                </div>
            `).join('');
            
            document.querySelectorAll('#lobby-grid .lobby-card').forEach(card => {
                const lobby = { id: card.dataset.lobbyId, name: card.dataset.lobbyName };
                card.addEventListener('click', () => switchToAppSoiHu(lobby));
                card.addEventListener('mouseenter', () => playSoundSoiHu(DOMElements.hoverSoundSoiHu));
            });

            /* lazy */ ensureVanillaTilt();
setInterval(updateLobbyStatsSoiHu, 3000);
        }

        function updateLobbyStatsSoiHu() {
            CONFIG.soiHuGames.lobbyGameList.forEach(game => {
                const signalEl = document.getElementById(`stat-signal-${game.id}`);
                const flowEl = document.getElementById(`stat-flow-${game.id}`);
                if (signalEl && flowEl) {
                    signalEl.textContent = `T√çN HI·ªÜU: ${(85 + Math.random() * 15).toFixed(1)}%`;
                    flowEl.textContent = `LU·ªíNG: ${(2 + Math.random() * 8).toFixed(2)} Tb/s`;
                }
            });
        }

        function renderAppContentSoiHu(lobby) {
            DOMElements.appTitleSoiHu.textContent = lobby.name;
            if (winRateInterval) clearInterval(winRateInterval);

            const games = CONFIG.soiHuGames.allGames[lobby.id];
            if (games) {
                renderGameGridSoiHu(`T·ªà L·ªÜ TH·∫ÆNG ${lobby.name}`, games);
            } else {
                DOMElements.dashboardContentSoiHu.innerHTML = `<p class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu cho s·∫£nh n√†y.</p>`;
            }
        }
        
        function renderGameGridSoiHu(title, games) {
            const hotGameIndex = Math.floor(Math.random() * games.length);
            DOMElements.dashboardContentSoiHu.innerHTML = `
                <h3 class="orbitron-font text-xl md:text-2xl text-center mb-4 aurora-text">${title}</h3>
                <div class="game-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-4 cv-auto">
                    ${games.map((game, index) => `
                        <div class="game-card ${index === hotGameIndex ? 'is-hot' : ''}" data-game-id="${game.id}">
                            ${index === hotGameIndex ? '<div class="hot-marker">HOT</div>' : ''}
                            <img src="${game.imageUrl}" alt="${game.name}" onerror="this.onerror=null;this.src='https://placehold.co/150/1a1a1a/ffffff?text=X';" loading="lazy" decoding="async" fetchpriority="low">
                            <h4 class="game-card-name">${game.name}</h4>
                            <div class="game-win-rate">
                                T·ªâ l·ªá: <span class="win-rate-value" id="win-rate-${game.id}"></span>%
                            </div>
                            <div class="win-rate-bar-bg">
                                <div class="win-rate-bar-fill" id="win-rate-bar-${game.id}"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.querySelectorAll('#dashboardContent .game-card').forEach(card => {
                card.addEventListener('click', () => {
                    const gameId = card.dataset.gameId;
                    const gameLobbyId = gameId.split('-')[0];
                    const game = CONFIG.soiHuGames.allGames[gameLobbyId].find(g => g.id === gameId);
                    if (game) showAnalysisModalSoiHu(game);
                });
            });

            const updateCallback = () => updateGameWinRatesSoiHu(games);
            updateCallback();
            winRateInterval = setInterval(updateCallback, 3000);
        }

        function updateGameWinRatesSoiHu(games) {
            games.forEach(game => {
                const textEl = document.getElementById(`win-rate-${game.id}`);
                const barEl = document.getElementById(`win-rate-bar-${game.id}`);
                if (textEl && barEl) {
                    const newRate = (60 + Math.random() * 35);
                    animateWinRateSoiHu(textEl, barEl, newRate);
                }
            });
        }

        function animateWinRateSoiHu(textElement, barElement, finalRate) {
            let iterations = 0;
            const maxIterations = 10;
            
            const interval = setInterval(() => {
                let scrambledText = (Math.random() * 99).toFixed(2);
                textElement.textContent = scrambledText;
                
                if(iterations >= maxIterations) {
                    clearInterval(interval);
                    textElement.textContent = finalRate.toFixed(2);
                    barElement.style.width = `${finalRate}%`;
                }
                iterations++;
            }, 50);
        }

        function populateAnalysisDataSoiHu(game) {
            document.getElementById('analysis-game-name').textContent = game.name;
            document.getElementById('analysis-game-img').src = game.imageUrl;
            DOMElements.planOutputSoiHu.classList.add('hidden');
            DOMElements.planInputSoiHu.value = '';

            document.getElementById('analysis-win-rate').textContent = `${(60 + Math.random() * 35).toFixed(2)}%`;
            document.getElementById('analysis-spin-count').textContent = Math.floor(Math.random() * (230 - 36 + 1)) + 36;
            document.getElementById('analysis-scatter-rate').textContent = `${(80 + Math.random() * 20).toFixed(2)}%`;

            const now = new Date();
            const intervals = [5, 10, 15, 18];
            const randomInterval = intervals[Math.floor(Math.random() * intervals.length)];
            const endTime = new Date(now.getTime() + randomInterval * 60000);
            
            const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('golden-time-value').textContent = `${formatTime(now)} - ${formatTime(endTime)}`;

            // Populate custom sections for Soi H·ªß interface
            // History & prediction population removed
// Update energy bar for Soi H·ªß view
            const energyBarEl = document.getElementById('energy-bar-soihu');
            const energyTextEl = document.getElementById('energy-text-soihu');
            if (energyBarEl && energyTextEl) {
                if (typeof currentUserData !== 'undefined' && currentUserData && CONFIG && CONFIG.energy && CONFIG.energy.max) {
                    const energyPercent = Math.max(0, (currentUserData.energy / CONFIG.energy.max) * 100);
                    energyBarEl.style.width = `${energyPercent}%`;
                    // Change bar color based on remaining energy
                    if (energyPercent > 60) {
                        energyBarEl.style.background = 'linear-gradient(90deg, var(--neon-green), var(--neon-blue))';
                    } else if (energyPercent > 30) {
                        energyBarEl.style.background = 'linear-gradient(90deg, #facc15, #fb923c)';
                    } else {
                        energyBarEl.style.background = 'linear-gradient(90deg, #fb923c, #ef4444)';
                    }
                    energyTextEl.textContent = `${Math.round(currentUserData.energy)} / ${CONFIG.energy.max}`;
                } else {
                    // Fallback values when user data is not available
                    energyBarEl.style.width = '100%';
                    energyBarEl.style.background = 'linear-gradient(90deg, var(--neon-green), var(--neon-blue))';
                    energyTextEl.textContent = '0 / 0';
                }
            }
        }

        function generatePlanSoiHu() {
            const input = DOMElements.planInputSoiHu;
            const capital = parseFloat(input.value);
            if (isNaN(capital) || capital <= 0) {
                DOMElements.planOutputSoiHu.textContent = "L·ªói: Vui l√≤ng nh·∫≠p m·ªôt s·ªë v·ªën h·ª£p l·ªá.";
                DOMElements.planOutputSoiHu.classList.remove('hidden');
                return;
            }

            const capitalInVND = capital * 1000;
            const baseBet = Math.max(1000, Math.floor((capitalInVND * 0.005) / 1000) * 1000);
            const goldenHourBet = baseBet * 2.5;
            const profitTarget = capitalInVND * 1.35;
            const stopLoss = capitalInVND * 0.7;

            const planText = `
K·∫æ HO·∫†CH CHI TI·∫æT CHO V·ªêN: ${capitalInVND.toLocaleString('vi-VN')}ƒë

- M·ª©c c∆∞·ª£c c∆° b·∫£n: ${baseBet.toLocaleString('vi-VN')}ƒë / v√≤ng
- V√≤ng quay ƒë·ªÅ xu·∫•t: 50 - 100 v√≤ng

- Trong Khung Gi·ªù V√†ng:
  + TƒÉng c∆∞·ª£c l√™n: ${goldenHourBet.toLocaleString('vi-VN')}ƒë / v√≤ng
  + S·ª≠ d·ª•ng t√≠nh nƒÉng mua v√≤ng quay mi·ªÖn ph√≠ n·∫øu c√≥.

- Qu·∫£n l√Ω v·ªën:
  + M·ª•c ti√™u l·ª£i nhu·∫≠n: ${profitTarget.toLocaleString('vi-VN')}ƒë (+35%)
  + Ng∆∞·ª°ng d·ª´ng l·ªó: ${stopLoss.toLocaleString('vi-VN')}ƒë (-30%)

*L∆∞u √Ω: K·∫ø ho·∫°ch ch·ªâ mang t√≠nh tham kh·∫£o.*
            `;
            DOMElements.planOutputSoiHu.textContent = planText.trim();
            DOMElements.planOutputSoiHu.classList.remove('hidden');
        }

        function startTickerSoiHu() {
            const tickerContent = DOMElements.tickerContentSoiHu;
            let allGameNames = [];
            for (const key in CONFIG.soiHuGames.allGames) {
                CONFIG.soiHuGames.allGames[key].forEach(game => allGameNames.push(game.name));
            }

            let tickerHTML = '';
            for (let i = 0; i < 10; i++) {
                const player = randomNamesSoiHu[Math.floor(Math.random() * randomNamesSoiHu.length)];
                const game = allGameNames[Math.floor(Math.random() * allGameNames.length)];
                const amount = (Math.floor(Math.random() * 500) + 50) * 10000;
                tickerHTML += `<span class="mx-8 text-cyan-400">${player}</span> v·ª´a th·∫Øng <span class="text-yellow-400 font-bold">${amount.toLocaleString('vi-VN')}ƒë</span> t·∫°i game <span class="text-purple-400">${game}</span>`;
            }
            tickerContent.innerHTML = tickerHTML;
        }

        function typeEffectSoiHu(element, text, speed) {
            let i = 0;
            element.innerHTML = "";
            const cursor = '<span class="animate-ping">_</span>';
            element.innerHTML = cursor;
            
            function type() {
                if (i < text.length) {
                    element.innerHTML = text.substring(0, i + 1) + cursor;
                    i++;
                    setTimeout(type, speed);
                } else {
                    element.innerHTML = text;
                }
            }
            type();
        }

        // --- MAIN INITIALIZATION & EVENT LISTENERS ---
        function setupEventListeners() {
            document.body.addEventListener('click', startMedia, { once: true });
            document.body.addEventListener('keydown', startMedia, { once: true });
            
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            DOMElements.registerForm.addEventListener('submit', handleRegister);
            DOMElements.showRegisterLink.addEventListener('click', () => { playSound('click'); DOMElements.loginForm.classList.add('hidden'); DOMElements.registerForm.classList.remove('hidden'); decodeText(DOMElements.registerForm.querySelector('h2')); });
            DOMElements.showLoginLink.addEventListener('click', () => { playSound('click'); DOMElements.registerForm.classList.add('hidden'); DOMElements.loginForm.classList.remove('hidden'); decodeText(DOMElements.loginForm.querySelector('h2')); });
            
            DOMElements.nextCoreBtn.addEventListener('click', () => handleCoreNavigation(1));
            DOMElements.prevCoreBtn.addEventListener('click', () => handleCoreNavigation(-1));
            DOMElements.logoutBtn.addEventListener('click', () => { logActivity("ƒêƒÉng xu·∫•t."); signOut(auth); showNotification("ƒê√£ ƒëƒÉng xu·∫•t.", "info"); });
            DOMElements.chatForm.addEventListener('submit', handleSendMessage);
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => { playSound('click'); btn.closest('.modal-overlay').classList.add('hidden'); }));
            DOMElements.profileBtn.addEventListener('click', () => {
                if (!currentUserData) return;
                playSound('open');
                DOMElements.profileModal.classList.remove('hidden');
            });
            DOMElements.exitLongbaoBtnTables.addEventListener('click', exitLongBaoIV);
            DOMElements.backToTablesBtn.addEventListener('click', showTableSelectionScreenLB4);
            DOMElements.modalConfirmBtnLB4.addEventListener('click', () => { DOMElements.energyModalLB4.classList.add('hidden'); exitLongBaoIV(); });
            
            // LongBao IV features
            DOMElements.advancedAnalysisBtn.addEventListener('click', handleAdvancedAnalysis);
            DOMElements.capitalInput.addEventListener('input', (e) => {
                userCapital = parseFloat(e.target.value) || 0;
                updateBettingSuggestion();
            });
            
            // Soi Hu event listeners
            document.querySelectorAll('#lobby-grid .lobby-card').forEach(card => card.addEventListener('click', () => switchToAppSoiHu(card)));
            DOMElements.backToLobbyBtnSoiHu.addEventListener('click', switchToLobbySoiHu);
            DOMElements.backToGamesBtnSoiHu.addEventListener('click', backToGameGridSoiHu);
            DOMElements.planButtonSoiHu.addEventListener('click', generatePlanSoiHu);
            DOMElements.exitSoiHuBtn.addEventListener('click', () => {
                exitSoiHu();
                // We need to also hide all other Soi Hu screens when exiting
                showScreenSoiHu(DOMElements.lobbyContainerSoiHu);
                DOMElements.appContainerSoiHu.classList.add('hidden');
                DOMElements.analysisContainerSoiHu.classList.add('hidden');
                DOMElements.scanContainerSoiHu.classList.add('hidden');
            });

            initDraggableRobot();
        }
        
        function init() {
            setupEventListeners(); 
            setupMatrixRain();
            initializeMedia();
            renderAICores();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    if (unsubscribeUser) unsubscribeUser();
                    unsubscribeUser = onSnapshot(doc(db, "users", user.uid), (doc) => {
                        if (doc.exists()) {
                            currentUserData = { ...doc.data(), energy: doc.data().energy || 0 };
                            updateUIWithUserData(currentUserData);
                        } else { signOut(auth); }
                    });

                    DOMElements.authScreen.classList.add('fade-out');
                    setTimeout(() => {
                        DOMElements.authScreen.classList.add('hidden');
                        DOMElements.aiCoreSelectionScreen.classList.remove('hidden');
                        DOMElements.aiCoreSelectionScreen.classList.add('fade-in');
                        DOMElements.userInfoBar.classList.remove('hidden');
                        DOMElements.chatRobotContainer.classList.remove('hidden');
                        decodeText(DOMElements.aiCoreSelectionScreen.querySelector('h1'));
                        initChatbot();
                    }, 500);
                } else {
                    if (unsubscribeUser) unsubscribeUser();
                    currentUserData = null;
                    DOMElements.authScreen.classList.remove('hidden', 'fade-out');
                    DOMElements.aiCoreSelectionScreen.classList.add('hidden');
                    DOMElements.longbaoIVScreen.classList.add('hidden');
                    DOMElements.soiHuScreen.classList.add('hidden');
                    DOMElements.userInfoBar.classList.add('hidden');
                    DOMElements.chatRobotContainer.classList.add('hidden');
                    DOMElements.chatWindowContainer.classList.add('hidden');
                    DOMElements.robotSpeechBubble.classList.remove('hidden');
                    decodeText(DOMElements.loginForm.querySelector('h2'));
                }
            });
        }
        
        init();

    </script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('pwa-service-worker.js')
    .then(function(reg) {
      console.log('Service Worker ƒëƒÉng k√Ω th√†nh c√¥ng', reg.scope);
    }).catch(function(error) {
      console.log('Service Worker ƒëƒÉng k√Ω th·∫•t b·∫°i', error);
    });
}
</script>


<script>
// G·ª≠i y√™u c·∫ßu quy·ªÅn th√¥ng b√°o
if ('Notification' in window && navigator.serviceWorker) {
  Notification.requestPermission().then(function(permission) {
    if (permission === 'granted') {
      console.log('Push Notification ƒë∆∞·ª£c c·∫•p quy·ªÅn');
    }
  });
}

// T·ª± ƒë·ªông reload n·∫øu service worker thay ƒë·ªïi
navigator.serviceWorker.addEventListener('controllerchange', function() {
  window.location.reload();
});
</script>

    <!-- Overlay container for integrated Yian core -->
    <div id="yian-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.95); z-index:10000;">
        <iframe id="yian-frame" style="width:100%; height:100%; border:none;"></iframe>
        <button id="close-yian-overlay" style="position:absolute; top:10px; right:10px; background:#ff0040; color:#fff; border:none; padding:10px 15px; font-size:14px; cursor:pointer; z-index:10001;">ƒê√≥ng</button>
    </div>

    <!-- Account protection modal overlay -->
    <div id="account-protection-modal">
        <div id="account-protection-content"></div>
    </div>

    <script>
    // ƒê√≥ng overlay Yian v√† xo√° n·ªôi dung iframe khi ng∆∞·ªùi d√πng nh·∫•n n√∫t ƒê√≥ng
    (function() {
        const closeBtn = document.getElementById('close-yian-overlay');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                const overlay = document.getElementById('yian-overlay');
                const frame = document.getElementById('yian-frame');
                if (frame) frame.src = '';
                if (overlay) overlay.style.display = 'none';
            });
        }
    })();
    </script>




</body>
</html>
